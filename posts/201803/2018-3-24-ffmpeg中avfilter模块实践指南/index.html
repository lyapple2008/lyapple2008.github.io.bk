<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>FFmpeg中AVFilter模块实践指南 | BeYoung</title><meta name=keywords content="FFmpeg"><meta name=description content="在做音视频相关的开发过程大体如下所示，对于其中的编码/解码，整个流程相对比较固定，使用ffmpeg可以很好的完成这部分的开发。对其中的帧数据处理（包括音频和视频数据）则相对要多样化一些，比如对视频做尺寸变换，进行音频音量均衡，直播中的美颜处理，多路流合成等等，这些都是属于流程中的帧数据处理。今天要介绍FFmpeg中的AVFilter模块进行帧数据处理的开发，AVFilter模块对帧数据处理进行了很好的抽象。AVFilter中的filter graph（滤波器图）概念非常适合帧数据处理中的多级滤波处理，同时对滤波器的接口进行了规定，后期添加一些自定义的滤波器也是很方便。网上关于AVFilter的介绍大多是基于ffmpeg的命令使用，基于代码实现的很少，最近项目中正好要使用到了AVFilter，写个小结，希望对有同样需求的小伙伴有帮助。"><meta name=author content="Marshall Liu"><link rel=canonical href=https://lyapple2008.github.io/posts/201803/2018-3-24-ffmpeg%E4%B8%ADavfilter%E6%A8%A1%E5%9D%97%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.2211ca3164be7830024f6aad2b3a2e520843a64f8f048445c3401c1249aa051d.css integrity="sha256-IhHKMWS+eDACT2qtKzouUghDpk+PBIRFw0AcEkmqBR0=" rel="preload stylesheet" as=style><link rel=icon href=https://lyapple2008.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://lyapple2008.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://lyapple2008.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://lyapple2008.github.io/apple-touch-icon.png><link rel=mask-icon href=https://lyapple2008.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://lyapple2008.github.io/posts/201803/2018-3-24-ffmpeg%E4%B8%ADavfilter%E6%A8%A1%E5%9D%97%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/katex.min.css integrity=sha384-bYdxxUwYipFNohQlHt0bjN/LCpueqWz13HufFEV1SUatKs1cm4L6fFgCi1jT643X crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/katex.min.js integrity=sha384-Qsn9KnoKISj6dI8g7p1HBlNpVx0I8p1SvlwOldgi3IorMle61nQy4zEahWYtljaz crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script><meta property="og:url" content="https://lyapple2008.github.io/posts/201803/2018-3-24-ffmpeg%E4%B8%ADavfilter%E6%A8%A1%E5%9D%97%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/"><meta property="og:site_name" content="BeYoung"><meta property="og:title" content="FFmpeg中AVFilter模块实践指南"><meta property="og:description" content="在做音视频相关的开发过程大体如下所示，对于其中的编码/解码，整个流程相对比较固定，使用ffmpeg可以很好的完成这部分的开发。对其中的帧数据处理（包括音频和视频数据）则相对要多样化一些，比如对视频做尺寸变换，进行音频音量均衡，直播中的美颜处理，多路流合成等等，这些都是属于流程中的帧数据处理。今天要介绍FFmpeg中的AVFilter模块进行帧数据处理的开发，AVFilter模块对帧数据处理进行了很好的抽象。AVFilter中的filter graph（滤波器图）概念非常适合帧数据处理中的多级滤波处理，同时对滤波器的接口进行了规定，后期添加一些自定义的滤波器也是很方便。网上关于AVFilter的介绍大多是基于ffmpeg的命令使用，基于代码实现的很少，最近项目中正好要使用到了AVFilter，写个小结，希望对有同样需求的小伙伴有帮助。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-03-24T22:55:27+00:00"><meta property="article:modified_time" content="2018-03-24T22:55:27+00:00"><meta property="article:tag" content="FFmpeg"><meta property="og:image" content="https://lyapple2008.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://lyapple2008.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="FFmpeg中AVFilter模块实践指南"><meta name=twitter:description content="在做音视频相关的开发过程大体如下所示，对于其中的编码/解码，整个流程相对比较固定，使用ffmpeg可以很好的完成这部分的开发。对其中的帧数据处理（包括音频和视频数据）则相对要多样化一些，比如对视频做尺寸变换，进行音频音量均衡，直播中的美颜处理，多路流合成等等，这些都是属于流程中的帧数据处理。今天要介绍FFmpeg中的AVFilter模块进行帧数据处理的开发，AVFilter模块对帧数据处理进行了很好的抽象。AVFilter中的filter graph（滤波器图）概念非常适合帧数据处理中的多级滤波处理，同时对滤波器的接口进行了规定，后期添加一些自定义的滤波器也是很方便。网上关于AVFilter的介绍大多是基于ffmpeg的命令使用，基于代码实现的很少，最近项目中正好要使用到了AVFilter，写个小结，希望对有同样需求的小伙伴有帮助。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://lyapple2008.github.io/posts/"},{"@type":"ListItem","position":2,"name":"FFmpeg中AVFilter模块实践指南","item":"https://lyapple2008.github.io/posts/201803/2018-3-24-ffmpeg%E4%B8%ADavfilter%E6%A8%A1%E5%9D%97%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"FFmpeg中AVFilter模块实践指南","name":"FFmpeg中AVFilter模块实践指南","description":"在做音视频相关的开发过程大体如下所示，对于其中的编码/解码，整个流程相对比较固定，使用ffmpeg可以很好的完成这部分的开发。对其中的帧数据处理（包括音频和视频数据）则相对要多样化一些，比如对视频做尺寸变换，进行音频音量均衡，直播中的美颜处理，多路流合成等等，这些都是属于流程中的帧数据处理。今天要介绍FFmpeg中的AVFilter模块进行帧数据处理的开发，AVFilter模块对帧数据处理进行了很好的抽象。AVFilter中的filter graph（滤波器图）概念非常适合帧数据处理中的多级滤波处理，同时对滤波器的接口进行了规定，后期添加一些自定义的滤波器也是很方便。网上关于AVFilter的介绍大多是基于ffmpeg的命令使用，基于代码实现的很少，最近项目中正好要使用到了AVFilter，写个小结，希望对有同样需求的小伙伴有帮助。\n","keywords":["FFmpeg"],"articleBody":"在做音视频相关的开发过程大体如下所示，对于其中的编码/解码，整个流程相对比较固定，使用ffmpeg可以很好的完成这部分的开发。对其中的帧数据处理（包括音频和视频数据）则相对要多样化一些，比如对视频做尺寸变换，进行音频音量均衡，直播中的美颜处理，多路流合成等等，这些都是属于流程中的帧数据处理。今天要介绍FFmpeg中的AVFilter模块进行帧数据处理的开发，AVFilter模块对帧数据处理进行了很好的抽象。AVFilter中的filter graph（滤波器图）概念非常适合帧数据处理中的多级滤波处理，同时对滤波器的接口进行了规定，后期添加一些自定义的滤波器也是很方便。网上关于AVFilter的介绍大多是基于ffmpeg的命令使用，基于代码实现的很少，最近项目中正好要使用到了AVFilter，写个小结，希望对有同样需求的小伙伴有帮助。\n原始音视频–\u003e解码–\u003e帧数据处理–\u003e编码–\u003e输出音视频\n1. 主要结构体和API介绍 1 2 3 4 5 6 // 对filters系统的整体管理 struct AVFilterGraph { AVFilterContext **filters; unsigned nb_filters; } 1 2 3 4 5 6 7 // 定义filter本身的能力，拥有的pads，回调函数接口定义 struct AVFilter { const char *name; const AVFilterPad *inputs; const AVFilterPad *outputs; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // filter实例，管理filter与外部的联系 struct AVFilterContext { const AVFilter *filter; char *name; AVFilterPad *input_pads; AVFilterLink **inputs; unsigned nb_inputs AVFilterPad *output_pads; AVFilterLink **outputs; unsigned nb_outputs; struct AVFilterGraph *graph; } 1 2 3 4 5 6 7 8 9 10 11 // 定义两个filters之间的联接 struct AVFilterLink { AVFilterContext *src; AVFilterPad *srcpad; AVFilterContext *dst; AVFilterPad *dstpad; struct AVFilterGraph *graph; } 1 2 3 4 5 6 7 8 9 // 定义filter的输入/输出接口 struct AVFilterPad { const char *name; AVFrame *(*get_video_buffer)(AVFilterLink *link, int w, int h); AVFrame *(*get_audio_buffer)(AVFilterLink *link, int nb_samples); int (*filter_frame)(AVFilterLink *link, AVFrame *frame); int (*request_frame)(AVFilterLink *link); } 1 2 3 4 5 6 7 struct AVFilterInOut { char *name; AVFilterContext *filter_ctx; int pad_idx; struct AVFilterInOut *next; } 在AVFilter模块中定义了AVFilter结构，很个AVFilter都是具有独立功能的节点，如scale filter的作用就是进行图像尺寸变换，overlay filter的作用就是进行图像的叠加，这里需要重点提的是两个特别的filter，一个是buffer，一个是buffersink，滤波器buffer代表filter graph中的源头，原始数据就往这个filter节点输入的；而滤波器buffersink代表filter graph中的输出节点，处理完成的数据从这个filter节点输出。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // 获取FFmpeg中定义的filter，调用该方法前需要先调用avfilter_register_all();进行滤波器注册 AVFilter *avfilter_get_by_name(const char *name); // 往源滤波器buffer中输入待处理的数据 int av_buffersrc_add_frame(AVFilterContext *ctx, AVFrame *frame); // 从目的滤波器buffersink中输出处理完的数据 int av_buffersink_get_frame(AVFilterContext *ctx, AVFrame *frame); // 创建一个滤波器图filter graph AVFilterGraph *avfilter_graph_alloc(void); // 创建一个滤波器实例AVFilterContext，并添加到AVFilterGraph中 int avfilter_graph_create_filter(AVFilterContext **filt_ctx, const AVFilter *filt, const char *name, const char *args, void *opaque, AVFilterGraph *graph_ctx); // 连接两个滤波器节点 int avfilter_link(AVFilterContext *src, unsigned srcpad, AVFilterContext *dst, unsigned dstpad); 2. AVFilter主体框架流程 在利用AVFilter进行音视频数据处理前先将在进行的处理流程绘制出来，现在以FFmpeg filter官方文档中的一个例子为例进行说明。\n1 2 3 4 5 [main] input --\u003e split ---------------------\u003e overlay --\u003e output | ^ |[tmp] [flip]| +-----\u003e crop --\u003e vflip -------+ 这个例子的处理流程如上所示，首先使用split滤波器将input流分成两路流（main和tmp），然后分别对两路流进行处理。对于tmp流，先经过crop滤波器进行裁剪处理，再经过flip滤波器进行垂直方向上的翻转操作，输出的结果命名为flip流。再将main流和flip流输入到overlay滤波器进行合成操作。上图的input就是上面提过的buffer源滤波器，output就是上面的提过的buffersink滤波器。上图中每个节点都是一个AVFilterContext，每个连线就是AVFliterLink。所有这些信息都统一由AVFilterGraph来管理。\n3. 实例实现 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 extern \"C\" { #include #include #include #include #include #include #include } int main(int argc, char* argv) { int ret = 0; // input yuv FILE* inFile = NULL; const char* inFileName = \"sintel_480x272_yuv420p.yuv\"; fopen_s(\u0026inFile, inFileName, \"rb+\"); if (!inFile) { printf(\"Fail to open file\\n\"); return -1; } int in_width = 480; int in_height = 272; // output yuv FILE* outFile = NULL; const char* outFileName = \"out_crop_vfilter.yuv\"; fopen_s(\u0026outFile, outFileName, \"wb\"); if (!outFile) { printf(\"Fail to create file for output\\n\"); return -1; } avfilter_register_all(); AVFilterGraph* filter_graph = avfilter_graph_alloc(); if (!filter_graph) { printf(\"Fail to create filter graph!\\n\"); return -1; } // source filter char args[512]; _snprintf_s(args, sizeof(args), \"video_size=%dx%d:pix_fmt=%d:time_base=%d/%d:pixel_aspect=%d/%d\", in_width, in_height, AV_PIX_FMT_YUV420P, 1, 25, 1, 1); AVFilter* bufferSrc = avfilter_get_by_name(\"buffer\"); AVFilterContext* bufferSrc_ctx; ret = avfilter_graph_create_filter(\u0026bufferSrc_ctx, bufferSrc, \"in\", args, NULL, filter_graph); if (ret \u003c 0) { printf(\"Fail to create filter bufferSrc\\n\"); return -1; } // sink filter AVBufferSinkParams *bufferSink_params; AVFilterContext* bufferSink_ctx; AVFilter* bufferSink = avfilter_get_by_name(\"buffersink\"); enum AVPixelFormat pix_fmts[] = { AV_PIX_FMT_YUV420P, AV_PIX_FMT_NONE }; bufferSink_params = av_buffersink_params_alloc(); bufferSink_params-\u003epixel_fmts = pix_fmts; ret = avfilter_graph_create_filter(\u0026bufferSink_ctx, bufferSink, \"out\", NULL, bufferSink_params, filter_graph); if (ret \u003c 0) { printf(\"Fail to create filter sink filter\\n\"); return -1; } // split filter AVFilter *splitFilter = avfilter_get_by_name(\"split\"); AVFilterContext *splitFilter_ctx; ret = avfilter_graph_create_filter(\u0026splitFilter_ctx, splitFilter, \"split\", \"outputs=2\", NULL, filter_graph); if (ret \u003c 0) { printf(\"Fail to create split filter\\n\"); return -1; } // crop filter AVFilter *cropFilter = avfilter_get_by_name(\"crop\"); AVFilterContext *cropFilter_ctx; ret = avfilter_graph_create_filter(\u0026cropFilter_ctx, cropFilter, \"crop\", \"out_w=iw:out_h=ih/2:x=0:y=0\", NULL, filter_graph); if (ret \u003c 0) { printf(\"Fail to create crop filter\\n\"); return -1; } // vflip filter AVFilter *vflipFilter = avfilter_get_by_name(\"vflip\"); AVFilterContext *vflipFilter_ctx; ret = avfilter_graph_create_filter(\u0026vflipFilter_ctx, vflipFilter, \"vflip\", NULL, NULL, filter_graph); if (ret \u003c 0) { printf(\"Fail to create vflip filter\\n\"); return -1; } // overlay filter AVFilter *overlayFilter = avfilter_get_by_name(\"overlay\"); AVFilterContext *overlayFilter_ctx; ret = avfilter_graph_create_filter(\u0026overlayFilter_ctx, overlayFilter, \"overlay\", \"y=0:H/2\", NULL, filter_graph); if (ret \u003c 0) { printf(\"Fail to create overlay filter\\n\"); return -1; } // src filter to split filter ret = avfilter_link(bufferSrc_ctx, 0, splitFilter_ctx, 0); if (ret != 0) { printf(\"Fail to link src filter and split filter\\n\"); return -1; } // split filter's first pad to overlay filter's main pad ret = avfilter_link(splitFilter_ctx, 0, overlayFilter_ctx, 0); if (ret != 0) { printf(\"Fail to link split filter and overlay filter main pad\\n\"); return -1; } // split filter's second pad to crop filter ret = avfilter_link(splitFilter_ctx, 1, cropFilter_ctx, 0); if (ret != 0) { printf(\"Fail to link split filter's second pad and crop filter\\n\"); return -1; } // crop filter to vflip filter ret = avfilter_link(cropFilter_ctx, 0, vflipFilter_ctx, 0); if (ret != 0) { printf(\"Fail to link crop filter and vflip filter\\n\"); return -1; } // vflip filter to overlay filter's second pad ret = avfilter_link(vflipFilter_ctx, 0, overlayFilter_ctx, 1); if (ret != 0) { printf(\"Fail to link vflip filter and overlay filter's second pad\\n\"); return -1; } // overlay filter to sink filter ret = avfilter_link(overlayFilter_ctx, 0, bufferSink_ctx, 0); if (ret != 0) { printf(\"Fail to link overlay filter and sink filter\\n\"); return -1; } // check filter graph ret = avfilter_graph_config(filter_graph, NULL); if (ret \u003c 0) { printf(\"Fail in filter graph\\n\"); return -1; } char *graph_str = avfilter_graph_dump(filter_graph, NULL); FILE* graphFile = NULL; fopen_s(\u0026graphFile, \"graphFile.txt\", \"w\"); fprintf(graphFile, \"%s\", graph_str); av_free(graph_str); AVFrame *frame_in = av_frame_alloc(); unsigned char *frame_buffer_in = (unsigned char *)av_malloc(av_image_get_buffer_size(AV_PIX_FMT_YUV420P, in_width, in_height, 1)); av_image_fill_arrays(frame_in-\u003edata, frame_in-\u003elinesize, frame_buffer_in, AV_PIX_FMT_YUV420P, in_width, in_height, 1); AVFrame *frame_out = av_frame_alloc(); unsigned char *frame_buffer_out = (unsigned char *)av_malloc(av_image_get_buffer_size(AV_PIX_FMT_YUV420P, in_width, in_height, 1)); av_image_fill_arrays(frame_out-\u003edata, frame_out-\u003elinesize, frame_buffer_out, AV_PIX_FMT_YUV420P, in_width, in_height, 1); frame_in-\u003ewidth = in_width; frame_in-\u003eheight = in_height; frame_in-\u003eformat = AV_PIX_FMT_YUV420P; while (1) { if (fread(frame_buffer_in, 1, in_width*in_height * 3 / 2, inFile) != in_width*in_height * 3 / 2) { break; } //input Y,U,V frame_in-\u003edata[0] = frame_buffer_in; frame_in-\u003edata[1] = frame_buffer_in + in_width*in_height; frame_in-\u003edata[2] = frame_buffer_in + in_width*in_height * 5 / 4; if (av_buffersrc_add_frame(bufferSrc_ctx, frame_in) \u003c 0) { printf(\"Error while add frame.\\n\"); break; } /* pull filtered pictures from the filtergraph */ ret = av_buffersink_get_frame(bufferSink_ctx, frame_out); if (ret \u003c 0) break; //output Y,U,V if (frame_out-\u003eformat == AV_PIX_FMT_YUV420P) { for (int i = 0; i \u003c frame_out-\u003eheight; i++) { fwrite(frame_out-\u003edata[0] + frame_out-\u003elinesize[0] * i, 1, frame_out-\u003ewidth, outFile); } for (int i = 0; i \u003c frame_out-\u003eheight / 2; i++) { fwrite(frame_out-\u003edata[1] + frame_out-\u003elinesize[1] * i, 1, frame_out-\u003ewidth / 2, outFile); } for (int i = 0; i \u003c frame_out-\u003eheight / 2; i++) { fwrite(frame_out-\u003edata[2] + frame_out-\u003elinesize[2] * i, 1, frame_out-\u003ewidth / 2, outFile); } } printf(\"Process 1 frame!\\n\"); av_frame_unref(frame_out); } fclose(inFile); fclose(outFile); av_frame_free(\u0026frame_in); av_frame_free(\u0026frame_out); avfilter_graph_free(\u0026filter_graph); return 0; } github代码仓库\n4. 建立定义Filter滤波器 这部分暂时还没有实践，参考ffmpeg源码中已有的filter和ffmpeg源码中的文档writing_filter.txt，应该实践起来也来难，等后面有时间再补上这部分介绍。\n","wordCount":"2649","inLanguage":"zh","image":"https://lyapple2008.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2018-03-24T22:55:27Z","dateModified":"2018-03-24T22:55:27Z","author":{"@type":"Person","name":"Marshall Liu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://lyapple2008.github.io/posts/201803/2018-3-24-ffmpeg%E4%B8%ADavfilter%E6%A8%A1%E5%9D%97%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/"},"publisher":{"@type":"Organization","name":"BeYoung","logo":{"@type":"ImageObject","url":"https://lyapple2008.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://lyapple2008.github.io/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://lyapple2008.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://lyapple2008.github.io/search/ title=搜索><span>搜索</span></a></li><li><a href=https://lyapple2008.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=https://lyapple2008.github.io/about_me/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://lyapple2008.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://lyapple2008.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">FFmpeg中AVFilter模块实践指南</h1><div class=post-meta><span title='2018-03-24 22:55:27 +0000 UTC'>三月 24, 2018</span>&nbsp;·&nbsp;6 分钟&nbsp;·&nbsp;2649 字&nbsp;·&nbsp;Marshall Liu</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#1-主要结构体和api介绍>1. 主要结构体和API介绍</a></li><li><a href=#2-avfilter主体框架流程>2. AVFilter主体框架流程</a></li><li><a href=#3-实例实现>3. 实例实现</a></li><li><a href=#4-建立定义filter滤波器>4. 建立定义Filter滤波器</a></li></ul></nav></div></details></div><div class=post-content><p>在做音视频相关的开发过程大体如下所示，对于其中的编码/解码，整个流程相对比较固定，使用ffmpeg可以很好的完成这部分的开发。对其中的帧数据处理（包括音频和视频数据）则相对要多样化一些，比如对视频做尺寸变换，进行音频音量均衡，直播中的美颜处理，多路流合成等等，这些都是属于流程中的帧数据处理。今天要介绍FFmpeg中的AVFilter模块进行帧数据处理的开发，AVFilter模块对帧数据处理进行了很好的抽象。AVFilter中的filter graph（滤波器图）概念非常适合帧数据处理中的多级滤波处理，同时对滤波器的接口进行了规定，后期添加一些自定义的滤波器也是很方便。网上关于AVFilter的介绍大多是基于ffmpeg的命令使用，基于代码实现的很少，最近项目中正好要使用到了AVFilter，写个小结，希望对有同样需求的小伙伴有帮助。</p><blockquote><p>原始音视频&ndash;>解码&ndash;>帧数据处理&ndash;>编码&ndash;>输出音视频</p></blockquote><h2 id=1-主要结构体和api介绍>1. 主要结构体和API介绍<a hidden class=anchor aria-hidden=true href=#1-主要结构体和api介绍>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// 对filters系统的整体管理
</span></span><span class=line><span class=cl>struct AVFilterGraph
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    AVFilterContext **filters;
</span></span><span class=line><span class=cl>    unsigned nb_filters;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>//</span> <span class=err>定义</span><span class=n>filter本身的能力</span><span class=err>，拥有的</span><span class=n>pads</span><span class=err>，回调函数接口定义</span>
</span></span><span class=line><span class=cl><span class=n>struct</span> <span class=n>AVFilter</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>char</span> <span class=o>*</span><span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>AVFilterPad</span> <span class=o>*</span><span class=n>inputs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>AVFilterPad</span> <span class=o>*</span><span class=n>outputs</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>//</span> <span class=n>filter实例</span><span class=err>，管理</span><span class=n>filter与外部的联系</span>
</span></span><span class=line><span class=cl><span class=n>struct</span> <span class=n>AVFilterContext</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>AVFilter</span> <span class=o>*</span><span class=n>filter</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>char</span> <span class=o>*</span><span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>AVFilterPad</span> <span class=o>*</span><span class=n>input_pads</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>AVFilterLink</span> <span class=o>**</span><span class=n>inputs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>unsigned</span> <span class=n>nb_inputs</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>AVFilterPad</span> <span class=o>*</span><span class=n>output_pads</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>AVFilterLink</span> <span class=o>**</span><span class=n>outputs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>unsigned</span> <span class=n>nb_outputs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>struct</span> <span class=n>AVFilterGraph</span> <span class=o>*</span><span class=n>graph</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// 定义两个filters之间的联接
</span></span><span class=line><span class=cl>struct AVFilterLink
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    AVFilterContext *src;
</span></span><span class=line><span class=cl>    AVFilterPad *srcpad;
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    AVFilterContext *dst;
</span></span><span class=line><span class=cl>    AVFilterPad *dstpad;
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    struct AVFilterGraph *graph;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>//</span> <span class=err>定义</span><span class=n>filter的输入</span><span class=o>/</span><span class=err>输出接口</span>
</span></span><span class=line><span class=cl><span class=n>struct</span> <span class=n>AVFilterPad</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>char</span> <span class=o>*</span><span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>AVFrame</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>get_video_buffer</span><span class=p>)(</span><span class=n>AVFilterLink</span> <span class=o>*</span><span class=n>link</span><span class=p>,</span> <span class=ne>int</span> <span class=n>w</span><span class=p>,</span> <span class=ne>int</span> <span class=n>h</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>AVFrame</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>get_audio_buffer</span><span class=p>)(</span><span class=n>AVFilterLink</span> <span class=o>*</span><span class=n>link</span><span class=p>,</span> <span class=ne>int</span> <span class=n>nb_samples</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=ne>int</span> <span class=p>(</span><span class=o>*</span><span class=n>filter_frame</span><span class=p>)(</span><span class=n>AVFilterLink</span> <span class=o>*</span><span class=n>link</span><span class=p>,</span> <span class=n>AVFrame</span> <span class=o>*</span><span class=n>frame</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=ne>int</span> <span class=p>(</span><span class=o>*</span><span class=n>request_frame</span><span class=p>)(</span><span class=n>AVFilterLink</span> <span class=o>*</span><span class=n>link</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>struct AVFilterInOut
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    char *name;
</span></span><span class=line><span class=cl>    AVFilterContext *filter_ctx;
</span></span><span class=line><span class=cl>    int pad_idx;
</span></span><span class=line><span class=cl>    struct AVFilterInOut *next;
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div><blockquote><p><em>在AVFilter模块中定义了AVFilter结构，很个AVFilter都是具有独立功能的节点，如scale filter的作用就是进行图像尺寸变换，overlay filter的作用就是进行图像的叠加，这里需要重点提的是两个特别的filter，一个是buffer，一个是buffersink，滤波器buffer代表filter graph中的源头，原始数据就往这个filter节点输入的；而滤波器buffersink代表filter graph中的输出节点，处理完成的数据从这个filter节点输出。</em></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>//</span> <span class=err>获取</span><span class=n>FFmpeg中定义的filter</span><span class=err>，调用该方法前需要先调用</span><span class=n>avfilter_register_all</span><span class=p>();</span><span class=err>进行滤波器注册</span>
</span></span><span class=line><span class=cl><span class=n>AVFilter</span> <span class=o>*</span><span class=n>avfilter_get_by_name</span><span class=p>(</span><span class=k>const</span> <span class=n>char</span> <span class=o>*</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=err>往源滤波器</span><span class=n>buffer中输入待处理的数据</span>
</span></span><span class=line><span class=cl><span class=ne>int</span> <span class=n>av_buffersrc_add_frame</span><span class=p>(</span><span class=n>AVFilterContext</span> <span class=o>*</span><span class=n>ctx</span><span class=p>,</span> <span class=n>AVFrame</span> <span class=o>*</span><span class=n>frame</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=err>从目的滤波器</span><span class=n>buffersink中输出处理完的数据</span>
</span></span><span class=line><span class=cl><span class=ne>int</span> <span class=n>av_buffersink_get_frame</span><span class=p>(</span><span class=n>AVFilterContext</span> <span class=o>*</span><span class=n>ctx</span><span class=p>,</span> <span class=n>AVFrame</span> <span class=o>*</span><span class=n>frame</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=err>创建一个滤波器图</span><span class=n>filter</span> <span class=n>graph</span>
</span></span><span class=line><span class=cl><span class=n>AVFilterGraph</span> <span class=o>*</span><span class=n>avfilter_graph_alloc</span><span class=p>(</span><span class=n>void</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=err>创建一个滤波器实例</span><span class=n>AVFilterContext</span><span class=err>，并添加到</span><span class=n>AVFilterGraph中</span>
</span></span><span class=line><span class=cl><span class=ne>int</span> <span class=n>avfilter_graph_create_filter</span><span class=p>(</span><span class=n>AVFilterContext</span> <span class=o>**</span><span class=n>filt_ctx</span><span class=p>,</span> <span class=k>const</span> <span class=n>AVFilter</span> <span class=o>*</span><span class=n>filt</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                 <span class=k>const</span> <span class=n>char</span> <span class=o>*</span><span class=n>name</span><span class=p>,</span> <span class=k>const</span> <span class=n>char</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=n>void</span> <span class=o>*</span><span class=n>opaque</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                 <span class=n>AVFilterGraph</span> <span class=o>*</span><span class=n>graph_ctx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=err>连接两个滤波器节点</span>
</span></span><span class=line><span class=cl><span class=ne>int</span> <span class=n>avfilter_link</span><span class=p>(</span><span class=n>AVFilterContext</span> <span class=o>*</span><span class=n>src</span><span class=p>,</span> <span class=n>unsigned</span> <span class=n>srcpad</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=n>AVFilterContext</span> <span class=o>*</span><span class=n>dst</span><span class=p>,</span> <span class=n>unsigned</span> <span class=n>dstpad</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div><h2 id=2-avfilter主体框架流程>2. AVFilter主体框架流程<a hidden class=anchor aria-hidden=true href=#2-avfilter主体框架流程>#</a></h2><p>在利用AVFilter进行音视频数据处理前先将在进行的处理流程绘制出来，现在以<a href=https://ffmpeg.org/ffmpeg-filters.html#Filtering-Introduction>FFmpeg filter官方文档</a>中的一个例子为例进行说明。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>                [main]
</span></span><span class=line><span class=cl>input --&gt; split ---------------------&gt; overlay --&gt; output
</span></span><span class=line><span class=cl>            |                             ^
</span></span><span class=line><span class=cl>            |[tmp]                  [flip]|
</span></span><span class=line><span class=cl>            +-----&gt; crop --&gt; vflip -------+</span></span></code></pre></td></tr></table></div></div><p>这个例子的处理流程如上所示，首先使用split滤波器将input流分成两路流（main和tmp），然后分别对两路流进行处理。对于tmp流，先经过crop滤波器进行裁剪处理，再经过flip滤波器进行垂直方向上的翻转操作，输出的结果命名为flip流。再将main流和flip流输入到overlay滤波器进行合成操作。上图的input就是上面提过的buffer源滤波器，output就是上面的提过的buffersink滤波器。上图中每个节点都是一个AVFilterContext，每个连线就是AVFliterLink。所有这些信息都统一由AVFilterGraph来管理。</p><p><img alt=image loading=lazy src=http://oxfmz0qm8.bkt.clouddn.com/ffmpeg/split_crop_vflip.png></p><h2 id=3-实例实现>3. 实例实现<a hidden class=anchor aria-hidden=true href=#3-实例实现>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>extern</span> <span class=s2>&#34;C&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=c1>#include &lt;libavcodec/avcodec.h&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>#include &lt;libavformat/avformat.h&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>#include &lt;libavfilter/avfiltergraph.h&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>#include &lt;libavfilter/buffersink.h&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>#include &lt;libavfilter/buffersrc.h&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>#include &lt;libavutil/opt.h&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>#include &lt;libavutil/imgutils.h&gt;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=ne>int</span> <span class=n>main</span><span class=p>(</span><span class=ne>int</span> <span class=n>argc</span><span class=p>,</span> <span class=n>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=ne>int</span> <span class=n>ret</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=n>input</span> <span class=n>yuv</span>
</span></span><span class=line><span class=cl>	<span class=n>FILE</span><span class=o>*</span> <span class=n>inFile</span> <span class=o>=</span> <span class=n>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=n>char</span><span class=o>*</span> <span class=n>inFileName</span> <span class=o>=</span> <span class=s2>&#34;sintel_480x272_yuv420p.yuv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>fopen_s</span><span class=p>(</span><span class=o>&amp;</span><span class=n>inFile</span><span class=p>,</span> <span class=n>inFileName</span><span class=p>,</span> <span class=s2>&#34;rb+&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>inFile</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s2>&#34;Fail to open file</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=ne>int</span> <span class=n>in_width</span> <span class=o>=</span> <span class=mi>480</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=ne>int</span> <span class=n>in_height</span> <span class=o>=</span> <span class=mi>272</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=n>output</span> <span class=n>yuv</span>
</span></span><span class=line><span class=cl>	<span class=n>FILE</span><span class=o>*</span> <span class=n>outFile</span> <span class=o>=</span> <span class=n>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=n>char</span><span class=o>*</span> <span class=n>outFileName</span> <span class=o>=</span> <span class=s2>&#34;out_crop_vfilter.yuv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>fopen_s</span><span class=p>(</span><span class=o>&amp;</span><span class=n>outFile</span><span class=p>,</span> <span class=n>outFileName</span><span class=p>,</span> <span class=s2>&#34;wb&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>outFile</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s2>&#34;Fail to create file for output</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>avfilter_register_all</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>AVFilterGraph</span><span class=o>*</span> <span class=n>filter_graph</span> <span class=o>=</span> <span class=n>avfilter_graph_alloc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>filter_graph</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s2>&#34;Fail to create filter graph!</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=n>source</span> <span class=n>filter</span>
</span></span><span class=line><span class=cl>	<span class=n>char</span> <span class=n>args</span><span class=p>[</span><span class=mi>512</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=n>_snprintf_s</span><span class=p>(</span><span class=n>args</span><span class=p>,</span> <span class=n>sizeof</span><span class=p>(</span><span class=n>args</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=s2>&#34;video_size=</span><span class=si>%d</span><span class=s2>x</span><span class=si>%d</span><span class=s2>:pix_fmt=</span><span class=si>%d</span><span class=s2>:time_base=</span><span class=si>%d</span><span class=s2>/</span><span class=si>%d</span><span class=s2>:pixel_aspect=</span><span class=si>%d</span><span class=s2>/</span><span class=si>%d</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=n>in_width</span><span class=p>,</span> <span class=n>in_height</span><span class=p>,</span> <span class=n>AV_PIX_FMT_YUV420P</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=mi>1</span><span class=p>,</span> <span class=mi>25</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>AVFilter</span><span class=o>*</span> <span class=n>bufferSrc</span> <span class=o>=</span> <span class=n>avfilter_get_by_name</span><span class=p>(</span><span class=s2>&#34;buffer&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>AVFilterContext</span><span class=o>*</span> <span class=n>bufferSrc_ctx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>ret</span> <span class=o>=</span> <span class=n>avfilter_graph_create_filter</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bufferSrc_ctx</span><span class=p>,</span> <span class=n>bufferSrc</span><span class=p>,</span> <span class=s2>&#34;in&#34;</span><span class=p>,</span> <span class=n>args</span><span class=p>,</span> <span class=n>NULL</span><span class=p>,</span> <span class=n>filter_graph</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s2>&#34;Fail to create filter bufferSrc</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=n>sink</span> <span class=n>filter</span>
</span></span><span class=line><span class=cl>	<span class=n>AVBufferSinkParams</span> <span class=o>*</span><span class=n>bufferSink_params</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>AVFilterContext</span><span class=o>*</span> <span class=n>bufferSink_ctx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>AVFilter</span><span class=o>*</span> <span class=n>bufferSink</span> <span class=o>=</span> <span class=n>avfilter_get_by_name</span><span class=p>(</span><span class=s2>&#34;buffersink&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>enum</span> <span class=n>AVPixelFormat</span> <span class=n>pix_fmts</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span> <span class=n>AV_PIX_FMT_YUV420P</span><span class=p>,</span> <span class=n>AV_PIX_FMT_NONE</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>	<span class=n>bufferSink_params</span> <span class=o>=</span> <span class=n>av_buffersink_params_alloc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=n>bufferSink_params</span><span class=o>-&gt;</span><span class=n>pixel_fmts</span> <span class=o>=</span> <span class=n>pix_fmts</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>ret</span> <span class=o>=</span> <span class=n>avfilter_graph_create_filter</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bufferSink_ctx</span><span class=p>,</span> <span class=n>bufferSink</span><span class=p>,</span> <span class=s2>&#34;out&#34;</span><span class=p>,</span> <span class=n>NULL</span><span class=p>,</span> <span class=n>bufferSink_params</span><span class=p>,</span> <span class=n>filter_graph</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s2>&#34;Fail to create filter sink filter</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=n>split</span> <span class=n>filter</span>
</span></span><span class=line><span class=cl>	<span class=n>AVFilter</span> <span class=o>*</span><span class=n>splitFilter</span> <span class=o>=</span> <span class=n>avfilter_get_by_name</span><span class=p>(</span><span class=s2>&#34;split&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>AVFilterContext</span> <span class=o>*</span><span class=n>splitFilter_ctx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>ret</span> <span class=o>=</span> <span class=n>avfilter_graph_create_filter</span><span class=p>(</span><span class=o>&amp;</span><span class=n>splitFilter_ctx</span><span class=p>,</span> <span class=n>splitFilter</span><span class=p>,</span> <span class=s2>&#34;split&#34;</span><span class=p>,</span> <span class=s2>&#34;outputs=2&#34;</span><span class=p>,</span> <span class=n>NULL</span><span class=p>,</span> <span class=n>filter_graph</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s2>&#34;Fail to create split filter</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=n>crop</span> <span class=n>filter</span>
</span></span><span class=line><span class=cl>	<span class=n>AVFilter</span> <span class=o>*</span><span class=n>cropFilter</span> <span class=o>=</span> <span class=n>avfilter_get_by_name</span><span class=p>(</span><span class=s2>&#34;crop&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>AVFilterContext</span> <span class=o>*</span><span class=n>cropFilter_ctx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>ret</span> <span class=o>=</span> <span class=n>avfilter_graph_create_filter</span><span class=p>(</span><span class=o>&amp;</span><span class=n>cropFilter_ctx</span><span class=p>,</span> <span class=n>cropFilter</span><span class=p>,</span> <span class=s2>&#34;crop&#34;</span><span class=p>,</span> <span class=s2>&#34;out_w=iw:out_h=ih/2:x=0:y=0&#34;</span><span class=p>,</span> <span class=n>NULL</span><span class=p>,</span> <span class=n>filter_graph</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s2>&#34;Fail to create crop filter</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=n>vflip</span> <span class=n>filter</span>
</span></span><span class=line><span class=cl>	<span class=n>AVFilter</span> <span class=o>*</span><span class=n>vflipFilter</span> <span class=o>=</span> <span class=n>avfilter_get_by_name</span><span class=p>(</span><span class=s2>&#34;vflip&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>AVFilterContext</span> <span class=o>*</span><span class=n>vflipFilter_ctx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>ret</span> <span class=o>=</span> <span class=n>avfilter_graph_create_filter</span><span class=p>(</span><span class=o>&amp;</span><span class=n>vflipFilter_ctx</span><span class=p>,</span> <span class=n>vflipFilter</span><span class=p>,</span> <span class=s2>&#34;vflip&#34;</span><span class=p>,</span> <span class=n>NULL</span><span class=p>,</span> <span class=n>NULL</span><span class=p>,</span> <span class=n>filter_graph</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s2>&#34;Fail to create vflip filter</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=n>overlay</span> <span class=n>filter</span>
</span></span><span class=line><span class=cl>	<span class=n>AVFilter</span> <span class=o>*</span><span class=n>overlayFilter</span> <span class=o>=</span> <span class=n>avfilter_get_by_name</span><span class=p>(</span><span class=s2>&#34;overlay&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>AVFilterContext</span> <span class=o>*</span><span class=n>overlayFilter_ctx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>ret</span> <span class=o>=</span> <span class=n>avfilter_graph_create_filter</span><span class=p>(</span><span class=o>&amp;</span><span class=n>overlayFilter_ctx</span><span class=p>,</span> <span class=n>overlayFilter</span><span class=p>,</span> <span class=s2>&#34;overlay&#34;</span><span class=p>,</span> <span class=s2>&#34;y=0:H/2&#34;</span><span class=p>,</span> <span class=n>NULL</span><span class=p>,</span> <span class=n>filter_graph</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s2>&#34;Fail to create overlay filter</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=n>src</span> <span class=n>filter</span> <span class=n>to</span> <span class=n>split</span> <span class=n>filter</span>
</span></span><span class=line><span class=cl>	<span class=n>ret</span> <span class=o>=</span> <span class=n>avfilter_link</span><span class=p>(</span><span class=n>bufferSrc_ctx</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>splitFilter_ctx</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s2>&#34;Fail to link src filter and split filter</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=n>split</span> <span class=n>filter</span><span class=s1>&#39;s first pad to overlay filter&#39;</span><span class=n>s</span> <span class=n>main</span> <span class=n>pad</span>
</span></span><span class=line><span class=cl>	<span class=n>ret</span> <span class=o>=</span> <span class=n>avfilter_link</span><span class=p>(</span><span class=n>splitFilter_ctx</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>overlayFilter_ctx</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s2>&#34;Fail to link split filter and overlay filter main pad</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=n>split</span> <span class=n>filter</span><span class=s1>&#39;s second pad to crop filter</span>
</span></span><span class=line><span class=cl>	<span class=n>ret</span> <span class=o>=</span> <span class=n>avfilter_link</span><span class=p>(</span><span class=n>splitFilter_ctx</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>cropFilter_ctx</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s2>&#34;Fail to link split filter&#39;s second pad and crop filter</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=n>crop</span> <span class=n>filter</span> <span class=n>to</span> <span class=n>vflip</span> <span class=n>filter</span>
</span></span><span class=line><span class=cl>	<span class=n>ret</span> <span class=o>=</span> <span class=n>avfilter_link</span><span class=p>(</span><span class=n>cropFilter_ctx</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>vflipFilter_ctx</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s2>&#34;Fail to link crop filter and vflip filter</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=n>vflip</span> <span class=n>filter</span> <span class=n>to</span> <span class=n>overlay</span> <span class=n>filter</span><span class=s1>&#39;s second pad</span>
</span></span><span class=line><span class=cl>	<span class=n>ret</span> <span class=o>=</span> <span class=n>avfilter_link</span><span class=p>(</span><span class=n>vflipFilter_ctx</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>overlayFilter_ctx</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s2>&#34;Fail to link vflip filter and overlay filter&#39;s second pad</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=n>overlay</span> <span class=n>filter</span> <span class=n>to</span> <span class=n>sink</span> <span class=n>filter</span>
</span></span><span class=line><span class=cl>	<span class=n>ret</span> <span class=o>=</span> <span class=n>avfilter_link</span><span class=p>(</span><span class=n>overlayFilter_ctx</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>bufferSink_ctx</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s2>&#34;Fail to link overlay filter and sink filter</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=n>check</span> <span class=n>filter</span> <span class=n>graph</span>
</span></span><span class=line><span class=cl>	<span class=n>ret</span> <span class=o>=</span> <span class=n>avfilter_graph_config</span><span class=p>(</span><span class=n>filter_graph</span><span class=p>,</span> <span class=n>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s2>&#34;Fail in filter graph</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>char</span> <span class=o>*</span><span class=n>graph_str</span> <span class=o>=</span> <span class=n>avfilter_graph_dump</span><span class=p>(</span><span class=n>filter_graph</span><span class=p>,</span> <span class=n>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>FILE</span><span class=o>*</span> <span class=n>graphFile</span> <span class=o>=</span> <span class=n>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>fopen_s</span><span class=p>(</span><span class=o>&amp;</span><span class=n>graphFile</span><span class=p>,</span> <span class=s2>&#34;graphFile.txt&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>fprintf</span><span class=p>(</span><span class=n>graphFile</span><span class=p>,</span> <span class=s2>&#34;</span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>graph_str</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>av_free</span><span class=p>(</span><span class=n>graph_str</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>AVFrame</span> <span class=o>*</span><span class=n>frame_in</span> <span class=o>=</span> <span class=n>av_frame_alloc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=n>unsigned</span> <span class=n>char</span> <span class=o>*</span><span class=n>frame_buffer_in</span> <span class=o>=</span> <span class=p>(</span><span class=n>unsigned</span> <span class=n>char</span> <span class=o>*</span><span class=p>)</span><span class=n>av_malloc</span><span class=p>(</span><span class=n>av_image_get_buffer_size</span><span class=p>(</span><span class=n>AV_PIX_FMT_YUV420P</span><span class=p>,</span> <span class=n>in_width</span><span class=p>,</span> <span class=n>in_height</span><span class=p>,</span> <span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=n>av_image_fill_arrays</span><span class=p>(</span><span class=n>frame_in</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>,</span> <span class=n>frame_in</span><span class=o>-&gt;</span><span class=n>linesize</span><span class=p>,</span> <span class=n>frame_buffer_in</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=n>AV_PIX_FMT_YUV420P</span><span class=p>,</span> <span class=n>in_width</span><span class=p>,</span> <span class=n>in_height</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>AVFrame</span> <span class=o>*</span><span class=n>frame_out</span> <span class=o>=</span> <span class=n>av_frame_alloc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=n>unsigned</span> <span class=n>char</span> <span class=o>*</span><span class=n>frame_buffer_out</span> <span class=o>=</span> <span class=p>(</span><span class=n>unsigned</span> <span class=n>char</span> <span class=o>*</span><span class=p>)</span><span class=n>av_malloc</span><span class=p>(</span><span class=n>av_image_get_buffer_size</span><span class=p>(</span><span class=n>AV_PIX_FMT_YUV420P</span><span class=p>,</span> <span class=n>in_width</span><span class=p>,</span> <span class=n>in_height</span><span class=p>,</span> <span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=n>av_image_fill_arrays</span><span class=p>(</span><span class=n>frame_out</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>,</span> <span class=n>frame_out</span><span class=o>-&gt;</span><span class=n>linesize</span><span class=p>,</span> <span class=n>frame_buffer_out</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=n>AV_PIX_FMT_YUV420P</span><span class=p>,</span> <span class=n>in_width</span><span class=p>,</span> <span class=n>in_height</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>frame_in</span><span class=o>-&gt;</span><span class=n>width</span> <span class=o>=</span> <span class=n>in_width</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>frame_in</span><span class=o>-&gt;</span><span class=n>height</span> <span class=o>=</span> <span class=n>in_height</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>frame_in</span><span class=o>-&gt;</span><span class=n>format</span> <span class=o>=</span> <span class=n>AV_PIX_FMT_YUV420P</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>fread</span><span class=p>(</span><span class=n>frame_buffer_in</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>in_width</span><span class=o>*</span><span class=n>in_height</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>/</span> <span class=mi>2</span><span class=p>,</span> <span class=n>inFile</span><span class=p>)</span> <span class=o>!=</span> <span class=n>in_width</span><span class=o>*</span><span class=n>in_height</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=o>//</span><span class=n>input</span> <span class=n>Y</span><span class=p>,</span><span class=n>U</span><span class=p>,</span><span class=n>V</span>
</span></span><span class=line><span class=cl>		<span class=n>frame_in</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>frame_buffer_in</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>frame_in</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>frame_buffer_in</span> <span class=o>+</span> <span class=n>in_width</span><span class=o>*</span><span class=n>in_height</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>frame_in</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>frame_buffer_in</span> <span class=o>+</span> <span class=n>in_width</span><span class=o>*</span><span class=n>in_height</span> <span class=o>*</span> <span class=mi>5</span> <span class=o>/</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>av_buffersrc_add_frame</span><span class=p>(</span><span class=n>bufferSrc_ctx</span><span class=p>,</span> <span class=n>frame_in</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>printf</span><span class=p>(</span><span class=s2>&#34;Error while add frame.</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=o>/*</span> <span class=n>pull</span> <span class=n>filtered</span> <span class=n>pictures</span> <span class=n>from</span> <span class=n>the</span> <span class=n>filtergraph</span> <span class=o>*/</span>
</span></span><span class=line><span class=cl>		<span class=n>ret</span> <span class=o>=</span> <span class=n>av_buffersink_get_frame</span><span class=p>(</span><span class=n>bufferSink_ctx</span><span class=p>,</span> <span class=n>frame_out</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=o>//</span><span class=n>output</span> <span class=n>Y</span><span class=p>,</span><span class=n>U</span><span class=p>,</span><span class=n>V</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>frame_out</span><span class=o>-&gt;</span><span class=n>format</span> <span class=o>==</span> <span class=n>AV_PIX_FMT_YUV420P</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=p>(</span><span class=ne>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>frame_out</span><span class=o>-&gt;</span><span class=n>height</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>fwrite</span><span class=p>(</span><span class=n>frame_out</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=n>frame_out</span><span class=o>-&gt;</span><span class=n>linesize</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=n>i</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>frame_out</span><span class=o>-&gt;</span><span class=n>width</span><span class=p>,</span> <span class=n>outFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=p>(</span><span class=ne>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>frame_out</span><span class=o>-&gt;</span><span class=n>height</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>fwrite</span><span class=p>(</span><span class=n>frame_out</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>frame_out</span><span class=o>-&gt;</span><span class=n>linesize</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>*</span> <span class=n>i</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>frame_out</span><span class=o>-&gt;</span><span class=n>width</span> <span class=o>/</span> <span class=mi>2</span><span class=p>,</span> <span class=n>outFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=p>(</span><span class=ne>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>frame_out</span><span class=o>-&gt;</span><span class=n>height</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>fwrite</span><span class=p>(</span><span class=n>frame_out</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>+</span> <span class=n>frame_out</span><span class=o>-&gt;</span><span class=n>linesize</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>*</span> <span class=n>i</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>frame_out</span><span class=o>-&gt;</span><span class=n>width</span> <span class=o>/</span> <span class=mi>2</span><span class=p>,</span> <span class=n>outFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s2>&#34;Process 1 frame!</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>av_frame_unref</span><span class=p>(</span><span class=n>frame_out</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>fclose</span><span class=p>(</span><span class=n>inFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>fclose</span><span class=p>(</span><span class=n>outFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>av_frame_free</span><span class=p>(</span><span class=o>&amp;</span><span class=n>frame_in</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>av_frame_free</span><span class=p>(</span><span class=o>&amp;</span><span class=n>frame_out</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>avfilter_graph_free</span><span class=p>(</span><span class=o>&amp;</span><span class=n>filter_graph</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><blockquote><p><a href=https://github.com/lyapple2008/FFmpegExams>github代码仓库</a></p></blockquote><h2 id=4-建立定义filter滤波器>4. 建立定义Filter滤波器<a hidden class=anchor aria-hidden=true href=#4-建立定义filter滤波器>#</a></h2><p>这部分暂时还没有实践，参考ffmpeg源码中已有的filter和ffmpeg源码中的文档writing_filter.txt，应该实践起来也来难，等后面有时间再补上这部分介绍。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://lyapple2008.github.io/tags/ffmpeg/>FFmpeg</a></li></ul><nav class=paginav><a class=prev href=https://lyapple2008.github.io/posts/201804/2018-04-29-android%E7%AB%AF%E5%AE%9E%E7%8E%B0%E6%89%8B%E5%86%99%E6%95%B0%E5%AD%97%E8%AF%86%E5%88%AB/><span class=title>« 上一页</span><br><span>Android端实现手写数字识别</span>
</a><a class=next href=https://lyapple2008.github.io/posts/201802/2018-2-19-2018%E5%B0%8F%E7%9B%AE%E6%A0%87/><span class=title>下一页 »</span><br><span>2018小目标</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share FFmpeg中AVFilter模块实践指南 on x" href="https://x.com/intent/tweet/?text=FFmpeg%e4%b8%adAVFilter%e6%a8%a1%e5%9d%97%e5%ae%9e%e8%b7%b5%e6%8c%87%e5%8d%97&amp;url=https%3a%2f%2flyapple2008.github.io%2fposts%2f201803%2f2018-3-24-ffmpeg%25E4%25B8%25ADavfilter%25E6%25A8%25A1%25E5%259D%2597%25E5%25AE%259E%25E8%25B7%25B5%25E6%258C%2587%25E5%258D%2597%2f&amp;hashtags=FFmpeg"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share FFmpeg中AVFilter模块实践指南 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2flyapple2008.github.io%2fposts%2f201803%2f2018-3-24-ffmpeg%25E4%25B8%25ADavfilter%25E6%25A8%25A1%25E5%259D%2597%25E5%25AE%259E%25E8%25B7%25B5%25E6%258C%2587%25E5%258D%2597%2f&amp;title=FFmpeg%e4%b8%adAVFilter%e6%a8%a1%e5%9d%97%e5%ae%9e%e8%b7%b5%e6%8c%87%e5%8d%97&amp;summary=FFmpeg%e4%b8%adAVFilter%e6%a8%a1%e5%9d%97%e5%ae%9e%e8%b7%b5%e6%8c%87%e5%8d%97&amp;source=https%3a%2f%2flyapple2008.github.io%2fposts%2f201803%2f2018-3-24-ffmpeg%25E4%25B8%25ADavfilter%25E6%25A8%25A1%25E5%259D%2597%25E5%25AE%259E%25E8%25B7%25B5%25E6%258C%2587%25E5%258D%2597%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share FFmpeg中AVFilter模块实践指南 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2flyapple2008.github.io%2fposts%2f201803%2f2018-3-24-ffmpeg%25E4%25B8%25ADavfilter%25E6%25A8%25A1%25E5%259D%2597%25E5%25AE%259E%25E8%25B7%25B5%25E6%258C%2587%25E5%258D%2597%2f&title=FFmpeg%e4%b8%adAVFilter%e6%a8%a1%e5%9d%97%e5%ae%9e%e8%b7%b5%e6%8c%87%e5%8d%97"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share FFmpeg中AVFilter模块实践指南 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2flyapple2008.github.io%2fposts%2f201803%2f2018-3-24-ffmpeg%25E4%25B8%25ADavfilter%25E6%25A8%25A1%25E5%259D%2597%25E5%25AE%259E%25E8%25B7%25B5%25E6%258C%2587%25E5%258D%2597%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share FFmpeg中AVFilter模块实践指南 on whatsapp" href="https://api.whatsapp.com/send?text=FFmpeg%e4%b8%adAVFilter%e6%a8%a1%e5%9d%97%e5%ae%9e%e8%b7%b5%e6%8c%87%e5%8d%97%20-%20https%3a%2f%2flyapple2008.github.io%2fposts%2f201803%2f2018-3-24-ffmpeg%25E4%25B8%25ADavfilter%25E6%25A8%25A1%25E5%259D%2597%25E5%25AE%259E%25E8%25B7%25B5%25E6%258C%2587%25E5%258D%2597%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share FFmpeg中AVFilter模块实践指南 on telegram" href="https://telegram.me/share/url?text=FFmpeg%e4%b8%adAVFilter%e6%a8%a1%e5%9d%97%e5%ae%9e%e8%b7%b5%e6%8c%87%e5%8d%97&amp;url=https%3a%2f%2flyapple2008.github.io%2fposts%2f201803%2f2018-3-24-ffmpeg%25E4%25B8%25ADavfilter%25E6%25A8%25A1%25E5%259D%2597%25E5%25AE%259E%25E8%25B7%25B5%25E6%258C%2587%25E5%258D%2597%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share FFmpeg中AVFilter模块实践指南 on ycombinator" href="https://news.ycombinator.com/submitlink?t=FFmpeg%e4%b8%adAVFilter%e6%a8%a1%e5%9d%97%e5%ae%9e%e8%b7%b5%e6%8c%87%e5%8d%97&u=https%3a%2f%2flyapple2008.github.io%2fposts%2f201803%2f2018-3-24-ffmpeg%25E4%25B8%25ADavfilter%25E6%25A8%25A1%25E5%259D%2597%25E5%25AE%259E%25E8%25B7%25B5%25E6%258C%2587%25E5%258D%2597%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><section><h2>Comments</h2><div id=comments-utteranc></div></section><script type=text/javascript>function getCurrentTheme(){return document.documentElement.getAttribute("data-theme")||document.body.classList.contains("dark")?"dark":"light"}function loadUtterances(e=!1){const t=document.getElementById("comments-utteranc");if(t!==null){t.innerHTML="";const n=document.createElement("script");n.setAttribute("id","utteranc"),n.setAttribute("src","https://utteranc.es/client.js"),n.setAttribute("data-repo","lyapple2008/comment"),n.setAttribute("data-category","Announcements"),n.setAttribute("data-mapping","pathname"),n.setAttribute("data-reactions-enabled","1"),n.setAttribute("data-emit-metadata","0"),n.setAttribute("data-theme",e?"github-dark":"github-light"),n.setAttribute("data-issue-term","title"),n.setAttribute("crossorigin","anonymous"),n.setAttribute("async","true"),t.appendChild(n)}}const isDarkMode=getCurrentTheme()==="dark";loadUtterances(isDarkMode);const themeObserver=new MutationObserver(e=>{e.forEach(e=>{if(e.type==="attributes"&&e.attributeName==="class"){const e=getCurrentTheme()==="dark";loadUtterances(e),console.log(`changing theme`)}})});themeObserver.observe(document.body,{attributes:!0,attributeFilter:["class"]})</script></article></main><footer class=footer><span>See this site&rsquo;s source code <a href=https://github.com/lyapple2008/lyapple2008.github.io>here</a>, licensed under GPLv3 ·</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>