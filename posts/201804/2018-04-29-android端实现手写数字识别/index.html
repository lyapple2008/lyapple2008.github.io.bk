<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Android端实现手写数字识别 | BeYoung</title><meta name=keywords content="Android,DeepLearning"><meta name=description content="  对DeepLearning最初的印象是，大量的训练样本+机器学习，也就是说原来传统的机器学习会遇到的问题，不能解决的问题，换成DeepLearning同样解决不了。比如目标识别中因为光照变化，目标被遮挡，目标的几何变化造成的识别率大幅下降，在DeepLearning中同样也不能很好解决。但是不是说DeepLearning就一无事处，最近几年这么热也决不是因为名字取得好。DeepLearning比较明显的优势就是在特征选择上，想想之前做生物特征识别时，各种找特征，还得考虑什么光照不变，旋转不变，抗尺寸变换，抗遮挡，那叫一个累呀。现在可好啦，一个Convolution   Layer，再配Fully Connected Layer，最后来个Softmax，丢一堆带标签的样本进去自动给你找出特征。当然这个只是一个接触DeepLearning不到一个月的小白的肤浅认识，大家听听就好。"><meta name=author content="Marshall Liu"><link rel=canonical href=https://lyapple2008.github.io/posts/201804/2018-04-29-android%E7%AB%AF%E5%AE%9E%E7%8E%B0%E6%89%8B%E5%86%99%E6%95%B0%E5%AD%97%E8%AF%86%E5%88%AB/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.2211ca3164be7830024f6aad2b3a2e520843a64f8f048445c3401c1249aa051d.css integrity="sha256-IhHKMWS+eDACT2qtKzouUghDpk+PBIRFw0AcEkmqBR0=" rel="preload stylesheet" as=style><link rel=icon href=https://lyapple2008.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://lyapple2008.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://lyapple2008.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://lyapple2008.github.io/apple-touch-icon.png><link rel=mask-icon href=https://lyapple2008.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://lyapple2008.github.io/posts/201804/2018-04-29-android%E7%AB%AF%E5%AE%9E%E7%8E%B0%E6%89%8B%E5%86%99%E6%95%B0%E5%AD%97%E8%AF%86%E5%88%AB/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/katex.min.css integrity=sha384-bYdxxUwYipFNohQlHt0bjN/LCpueqWz13HufFEV1SUatKs1cm4L6fFgCi1jT643X crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/katex.min.js integrity=sha384-Qsn9KnoKISj6dI8g7p1HBlNpVx0I8p1SvlwOldgi3IorMle61nQy4zEahWYtljaz crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script><meta property="og:url" content="https://lyapple2008.github.io/posts/201804/2018-04-29-android%E7%AB%AF%E5%AE%9E%E7%8E%B0%E6%89%8B%E5%86%99%E6%95%B0%E5%AD%97%E8%AF%86%E5%88%AB/"><meta property="og:site_name" content="BeYoung"><meta property="og:title" content="Android端实现手写数字识别"><meta property="og:description" content=" 对DeepLearning最初的印象是，大量的训练样本+机器学习，也就是说原来传统的机器学习会遇到的问题，不能解决的问题，换成DeepLearning同样解决不了。比如目标识别中因为光照变化，目标被遮挡，目标的几何变化造成的识别率大幅下降，在DeepLearning中同样也不能很好解决。但是不是说DeepLearning就一无事处，最近几年这么热也决不是因为名字取得好。DeepLearning比较明显的优势就是在特征选择上，想想之前做生物特征识别时，各种找特征，还得考虑什么光照不变，旋转不变，抗尺寸变换，抗遮挡，那叫一个累呀。现在可好啦，一个Convolution Layer，再配Fully Connected Layer，最后来个Softmax，丢一堆带标签的样本进去自动给你找出特征。当然这个只是一个接触DeepLearning不到一个月的小白的肤浅认识，大家听听就好。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-04-29T10:56:38+00:00"><meta property="article:modified_time" content="2018-04-29T10:56:38+00:00"><meta property="article:tag" content="Android"><meta property="article:tag" content="DeepLearning"><meta property="og:image" content="https://lyapple2008.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://lyapple2008.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Android端实现手写数字识别"><meta name=twitter:description content="  对DeepLearning最初的印象是，大量的训练样本+机器学习，也就是说原来传统的机器学习会遇到的问题，不能解决的问题，换成DeepLearning同样解决不了。比如目标识别中因为光照变化，目标被遮挡，目标的几何变化造成的识别率大幅下降，在DeepLearning中同样也不能很好解决。但是不是说DeepLearning就一无事处，最近几年这么热也决不是因为名字取得好。DeepLearning比较明显的优势就是在特征选择上，想想之前做生物特征识别时，各种找特征，还得考虑什么光照不变，旋转不变，抗尺寸变换，抗遮挡，那叫一个累呀。现在可好啦，一个Convolution   Layer，再配Fully Connected Layer，最后来个Softmax，丢一堆带标签的样本进去自动给你找出特征。当然这个只是一个接触DeepLearning不到一个月的小白的肤浅认识，大家听听就好。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://lyapple2008.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Android端实现手写数字识别","item":"https://lyapple2008.github.io/posts/201804/2018-04-29-android%E7%AB%AF%E5%AE%9E%E7%8E%B0%E6%89%8B%E5%86%99%E6%95%B0%E5%AD%97%E8%AF%86%E5%88%AB/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Android端实现手写数字识别","name":"Android端实现手写数字识别","description":" 对DeepLearning最初的印象是，大量的训练样本+机器学习，也就是说原来传统的机器学习会遇到的问题，不能解决的问题，换成DeepLearning同样解决不了。比如目标识别中因为光照变化，目标被遮挡，目标的几何变化造成的识别率大幅下降，在DeepLearning中同样也不能很好解决。但是不是说DeepLearning就一无事处，最近几年这么热也决不是因为名字取得好。DeepLearning比较明显的优势就是在特征选择上，想想之前做生物特征识别时，各种找特征，还得考虑什么光照不变，旋转不变，抗尺寸变换，抗遮挡，那叫一个累呀。现在可好啦，一个Convolution Layer，再配Fully Connected Layer，最后来个Softmax，丢一堆带标签的样本进去自动给你找出特征。当然这个只是一个接触DeepLearning不到一个月的小白的肤浅认识，大家听听就好。\n","keywords":["Android","DeepLearning"],"articleBody":" 对DeepLearning最初的印象是，大量的训练样本+机器学习，也就是说原来传统的机器学习会遇到的问题，不能解决的问题，换成DeepLearning同样解决不了。比如目标识别中因为光照变化，目标被遮挡，目标的几何变化造成的识别率大幅下降，在DeepLearning中同样也不能很好解决。但是不是说DeepLearning就一无事处，最近几年这么热也决不是因为名字取得好。DeepLearning比较明显的优势就是在特征选择上，想想之前做生物特征识别时，各种找特征，还得考虑什么光照不变，旋转不变，抗尺寸变换，抗遮挡，那叫一个累呀。现在可好啦，一个Convolution Layer，再配Fully Connected Layer，最后来个Softmax，丢一堆带标签的样本进去自动给你找出特征。当然这个只是一个接触DeepLearning不到一个月的小白的肤浅认识，大家听听就好。\n本文算是最近1个月学习DeepLearning的入门小作业，选择的例子也是DeepLearning最流行的HelloWorld程序MNIST手写数字识别，采用Caffe2进行训练，并在Android端实现一个Demo样例。\nDeepLearning基础 这里推荐下台大李宏毅老师的DeepLearning课程，讲解风趣幽默，生动详细，力荐。B站链接 深度学习框架：caffe2\n模型训练 整个模型训练过程主要包括数据准备、模型建立、模型训练，参考caffe2官网的tutorial\n1. 数据准备 数据准备在MachineLearning类的应用中起到致关重要的作用，相当于煮饭的时候用到的米。再利害的算法，如果没有足够的数据，那也是巧妇难为无米之炊，难道马云会称现在是DT时代。另外DeepLearning作为MachineLearning的一个分支，目前了解到的大部分的DeepLearning算法更多的还是属于SuperviseLearning。SuperviseLearning一个明显的特征是非常依赖数据，而且是人工标注的数据，这也难怪一些DeepLearning大大们说在AI应用中，有多少人工就有多少智能。本文用到的数据链接地址：MNIST手写数字数据集\n2. 模型建立 这个例子采用的是DeepLearning中的经典网络LeNet，关于LeNet可以参考这篇文章。\n3. 模型训练 这里模型训练采用caffe2框架，\n模型在Android端的部署 参考caffe2官网给的AICamera例子，建立Android Studio工程（github工程地址：https://github.com/lyapple2008/MNIST_CNN_APP ），其中最主要的代码如下所示\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 void loadToNetDef(AAssetManager *mgr, caffe2::NetDef *net, const char *filename) { AAsset *asset = AAssetManager_open(mgr, filename, AASSET_MODE_BUFFER); assert(asset != nullptr); const void *data = AAsset_getBuffer(asset); assert(data != nullptr); off_t len = AAsset_getLength(asset); assert(len != 0); if (!net-\u003eParseFromArray(data, len)) { alog(\"Couldn't parse net from data.\\n\"); } AAsset_close(asset); } extern \"C\" void Java_com_example_beyoung_handwrittendigit_MainActivity_initCaffe2( JNIEnv *env, jobject, jobject assetManager) { AAssetManager *mgr = AAssetManager_fromJava(env, assetManager); alog(\"Attempting to load protobuf netdefs...\"); loadToNetDef(mgr, \u0026_initNet, \"mnist/init_net.pb\"); loadToNetDef(mgr, \u0026_predictNet, \"mnist/predict_net.pb\"); alog(\"done.\"); alog(\"Instantiating predictor...\"); _predictor = new caffe2::Predictor(_initNet, _predictNet); if (_predictor) { alog(\"done...\"); } else { alog(\"fail to instantiat predictor...\"); } } extern \"C\" JNIEXPORT jstring JNICALL Java_com_example_beyoung_handwrittendigit_MainActivity_recognitionFromCaffe2( JNIEnv *env, jobject, jint h, jint w, jintArray data) { if (!_predictor) { return env-\u003eNewStringUTF(\"Loading...\"); } jsize len = env-\u003eGetArrayLength(data); jint *img_data = env-\u003eGetIntArrayElements(data, 0); jint img_size = h * w; assert(img_size \u003c= INPUT_DATA_SIZE); // convert rgb image to grey image and normalize to 0~1 for (auto i = 0; i \u003c h; ++i) { std::ostringstream stringStream; for (auto j = 0; j \u003c w; ++j) { int color = img_data[i * w + j]; //int red = ((color \u0026 0x00FF0000) \u003e\u003e 16); //int green = ((color \u0026 0x0000FF00) \u003e\u003e 8); //int blue = color \u0026 0x000000FF; //float grey = red * 0.3 + green * 0.59 + blue * 0.11; float grey = 0.0; if (color != 0) { grey = 1.0; } input_data[i * w + j] = grey; //alog(\"%f\", grey); //alog(\"%d\", color); if (color != 0) { color = 1; } stringStream \u003c\u003c color \u003c\u003c \" \"; } //alog(\"\\n\"); alog(\"%s\", stringStream.str().c_str()); } caffe2::TensorCPU input; input.Resize(std::vector\u003cint\u003e({1, IMG_C, IMG_H, IMG_W})); memcpy(input.mutable_data\u003cfloat\u003e(), input_data, INPUT_DATA_SIZE * sizeof(float)); caffe2::Predictor::TensorVector input_vec{\u0026input}; caffe2::Predictor::TensorVector output_vec; _predictor-\u003erun(input_vec, \u0026output_vec); constexpr int k = 3; float max[k] = {0}; int max_index[k] = {0}; // Find the top-k result manually if (output_vec.capacity() \u003e 0) { for (auto output : output_vec) { for (auto i = 0; i \u003c output-\u003esize(); ++i) { for (auto j = 0; j \u003c k; ++j) { if (output-\u003etemplate data\u003cfloat\u003e()[i] \u003e max[j]) { for (auto _j = k - 1; _j \u003e j; --_j) { max[_j - 1] = max[_j]; max_index[_j - 1] = max_index[_j]; } max[j] = output-\u003etemplate data\u003cfloat\u003e()[i]; max_index[j] = i; goto skip; } } skip:; } } } std::ostringstream stringStream; for (auto j = 0; j \u003c k; ++j) { stringStream \u003c\u003c max_index[j] \u003c\u003c \": \" \u003c\u003c max[j]*100 \u003c\u003c \"%\\n\"; } // if (output_vec.capacity() \u003e 0) { // for (auto output: output_vec) { // for (auto i = 0;i\u003coutput-\u003esize();++i) { // stringStream \u003c\u003c output-\u003etemplate data\u003cfloat\u003e()[i] \u003c\u003c \"\\n\"; // } // } // } return env-\u003eNewStringUTF(stringStream.str().c_str()); } 总结 通过上面的Demo可以看出，通过MNIST数据训练出来的模型在实际运行的准确率还是很堪忧的。所以一个算法从实验室数据到实际应用还有很长的路要走，虽然最近应用于各个领域的深度学习模型层出不穷，测试数据也很好看，但是在实际应用过程中还有很多路要走。虽然DeepLearning已经表现出很强大的黑魔法属性，在实际应用过程中还是有很多工作要做，不然只能停留在Demo阶段。以本文的手写数字识别为例，实际过程的准确率与测试集上的准确率相差甚远，这时候就需要进行大量的优化工作。由于学习深度学习没多久，暂时只能根据以往在机器学习上的经验来进行优化，目前能想到的优化方向有：训练集与实际运行环境要一致、准备更多的训练集、深度另外的模型方法。\n","wordCount":"1959","inLanguage":"zh","image":"https://lyapple2008.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2018-04-29T10:56:38Z","dateModified":"2018-04-29T10:56:38Z","author":{"@type":"Person","name":"Marshall Liu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://lyapple2008.github.io/posts/201804/2018-04-29-android%E7%AB%AF%E5%AE%9E%E7%8E%B0%E6%89%8B%E5%86%99%E6%95%B0%E5%AD%97%E8%AF%86%E5%88%AB/"},"publisher":{"@type":"Organization","name":"BeYoung","logo":{"@type":"ImageObject","url":"https://lyapple2008.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://lyapple2008.github.io/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://lyapple2008.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://lyapple2008.github.io/search/ title=搜索><span>搜索</span></a></li><li><a href=https://lyapple2008.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=https://lyapple2008.github.io/about_me/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://lyapple2008.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://lyapple2008.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Android端实现手写数字识别</h1><div class=post-meta><span title='2018-04-29 10:56:38 +0000 UTC'>四月 29, 2018</span>&nbsp;·&nbsp;4 分钟&nbsp;·&nbsp;1959 字&nbsp;·&nbsp;Marshall Liu</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#deeplearning基础>DeepLearning基础</a></li><li><a href=#模型训练>模型训练</a></li><li><a href=#模型在android端的部署>模型在Android端的部署</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div></details></div><div class=post-content><p>  对DeepLearning最初的印象是，大量的训练样本+机器学习，也就是说原来传统的机器学习会遇到的问题，不能解决的问题，换成DeepLearning同样解决不了。比如目标识别中因为光照变化，目标被遮挡，目标的几何变化造成的识别率大幅下降，在DeepLearning中同样也不能很好解决。但是不是说DeepLearning就一无事处，最近几年这么热也决不是因为名字取得好。DeepLearning比较明显的优势就是在特征选择上，想想之前做生物特征识别时，各种找特征，还得考虑什么光照不变，旋转不变，抗尺寸变换，抗遮挡，那叫一个累呀。现在可好啦，一个Convolution Layer，再配Fully Connected Layer，最后来个Softmax，丢一堆带标签的样本进去自动给你找出特征。当然这个只是一个接触DeepLearning不到一个月的小白的肤浅认识，大家听听就好。</p><p>  本文算是最近1个月学习DeepLearning的入门小作业，选择的例子也是DeepLearning最流行的HelloWorld程序MNIST手写数字识别，采用Caffe2进行训练，并在Android端实现一个Demo样例。</p><h3 id=deeplearning基础>DeepLearning基础<a hidden class=anchor aria-hidden=true href=#deeplearning基础>#</a></h3><p>  这里推荐下台大李宏毅老师的DeepLearning课程，讲解风趣幽默，生动详细，力荐。<a href=https://www.bilibili.com/video/av15889450>B站链接</a>
深度学习框架：caffe2</p><h3 id=模型训练>模型训练<a hidden class=anchor aria-hidden=true href=#模型训练>#</a></h3><p>整个模型训练过程主要包括数据准备、模型建立、模型训练，参考caffe2官网的<a href=https://github.com/caffe2/tutorials/blob/master/MNIST.ipynb>tutorial</a></p><h4 id=1-数据准备>1. 数据准备<a hidden class=anchor aria-hidden=true href=#1-数据准备>#</a></h4><p>数据准备在MachineLearning类的应用中起到致关重要的作用，相当于煮饭的时候用到的米。再利害的算法，如果没有足够的数据，那也是巧妇难为无米之炊，难道马云会称现在是DT时代。另外DeepLearning作为MachineLearning的一个分支，目前了解到的大部分的DeepLearning算法更多的还是属于SuperviseLearning。SuperviseLearning一个明显的特征是非常依赖数据，而且是人工标注的数据，这也难怪一些DeepLearning大大们说在AI应用中，有多少人工就有多少智能。本文用到的数据链接地址：<a href=http://yann.lecun.com/exdb/mnist/>MNIST手写数字数据集</a></p><h5 id=2-模型建立>2. 模型建立<a hidden class=anchor aria-hidden=true href=#2-模型建立>#</a></h5><p>这个例子采用的是DeepLearning中的经典网络LeNet，关于LeNet可以参考<a href=https://ujjwalkarn.me/2016/08/11/intuitive-explanation-convnets/>这篇文章</a>。</p><h5 id=3-模型训练>3. 模型训练<a hidden class=anchor aria-hidden=true href=#3-模型训练>#</a></h5><p>这里模型训练采用caffe2框架，</p><h3 id=模型在android端的部署>模型在Android端的部署<a hidden class=anchor aria-hidden=true href=#模型在android端的部署>#</a></h3><p>参考caffe2官网给的AICamera例子，建立Android Studio工程（github工程地址：https://github.com/lyapple2008/MNIST_CNN_APP ），其中最主要的代码如下所示</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>void</span> <span class=n>loadToNetDef</span><span class=p>(</span><span class=n>AAssetManager</span> <span class=o>*</span><span class=n>mgr</span><span class=p>,</span> <span class=n>caffe2</span><span class=p>::</span><span class=n>NetDef</span> <span class=o>*</span><span class=n>net</span><span class=p>,</span> <span class=k>const</span> <span class=n>char</span> <span class=o>*</span><span class=n>filename</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>AAsset</span> <span class=o>*</span><span class=n>asset</span> <span class=o>=</span> <span class=n>AAssetManager_open</span><span class=p>(</span><span class=n>mgr</span><span class=p>,</span> <span class=n>filename</span><span class=p>,</span> <span class=n>AASSET_MODE_BUFFER</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nb>assert</span><span class=p>(</span><span class=n>asset</span> <span class=o>!=</span> <span class=n>nullptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>void</span> <span class=o>*</span><span class=n>data</span> <span class=o>=</span> <span class=n>AAsset_getBuffer</span><span class=p>(</span><span class=n>asset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nb>assert</span><span class=p>(</span><span class=n>data</span> <span class=o>!=</span> <span class=n>nullptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>off_t</span> <span class=n>len</span> <span class=o>=</span> <span class=n>AAsset_getLength</span><span class=p>(</span><span class=n>asset</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nb>assert</span><span class=p>(</span><span class=n>len</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>net</span><span class=o>-&gt;</span><span class=n>ParseFromArray</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>len</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>alog</span><span class=p>(</span><span class=s2>&#34;Couldn&#39;t parse net from data.</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>AAsset_close</span><span class=p>(</span><span class=n>asset</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>extern</span> <span class=s2>&#34;C&#34;</span>
</span></span><span class=line><span class=cl><span class=n>void</span> <span class=n>Java_com_example_beyoung_handwrittendigit_MainActivity_initCaffe2</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>JNIEnv</span> <span class=o>*</span><span class=n>env</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>jobject</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>jobject</span> <span class=n>assetManager</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>AAssetManager</span> <span class=o>*</span><span class=n>mgr</span> <span class=o>=</span> <span class=n>AAssetManager_fromJava</span><span class=p>(</span><span class=n>env</span><span class=p>,</span> <span class=n>assetManager</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>alog</span><span class=p>(</span><span class=s2>&#34;Attempting to load protobuf netdefs...&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>loadToNetDef</span><span class=p>(</span><span class=n>mgr</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>_initNet</span><span class=p>,</span> <span class=s2>&#34;mnist/init_net.pb&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>loadToNetDef</span><span class=p>(</span><span class=n>mgr</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>_predictNet</span><span class=p>,</span> <span class=s2>&#34;mnist/predict_net.pb&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>alog</span><span class=p>(</span><span class=s2>&#34;done.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>alog</span><span class=p>(</span><span class=s2>&#34;Instantiating predictor...&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>_predictor</span> <span class=o>=</span> <span class=n>new</span> <span class=n>caffe2</span><span class=p>::</span><span class=n>Predictor</span><span class=p>(</span><span class=n>_initNet</span><span class=p>,</span> <span class=n>_predictNet</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>_predictor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>alog</span><span class=p>(</span><span class=s2>&#34;done...&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>alog</span><span class=p>(</span><span class=s2>&#34;fail to instantiat predictor...&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>extern</span> <span class=s2>&#34;C&#34;</span>
</span></span><span class=line><span class=cl><span class=n>JNIEXPORT</span> <span class=n>jstring</span> <span class=n>JNICALL</span>
</span></span><span class=line><span class=cl><span class=n>Java_com_example_beyoung_handwrittendigit_MainActivity_recognitionFromCaffe2</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>JNIEnv</span> <span class=o>*</span><span class=n>env</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>jobject</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>jint</span> <span class=n>h</span><span class=p>,</span> <span class=n>jint</span> <span class=n>w</span><span class=p>,</span> <span class=n>jintArray</span> <span class=n>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>_predictor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>env</span><span class=o>-&gt;</span><span class=n>NewStringUTF</span><span class=p>(</span><span class=s2>&#34;Loading...&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>jsize</span> <span class=n>len</span> <span class=o>=</span> <span class=n>env</span><span class=o>-&gt;</span><span class=n>GetArrayLength</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>jint</span> <span class=o>*</span><span class=n>img_data</span> <span class=o>=</span> <span class=n>env</span><span class=o>-&gt;</span><span class=n>GetIntArrayElements</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>jint</span> <span class=n>img_size</span> <span class=o>=</span> <span class=n>h</span> <span class=o>*</span> <span class=n>w</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>assert</span><span class=p>(</span><span class=n>img_size</span> <span class=o>&lt;=</span> <span class=n>INPUT_DATA_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=nb>convert</span> <span class=n>rgb</span> <span class=n>image</span> <span class=n>to</span> <span class=n>grey</span> <span class=n>image</span> <span class=ow>and</span> <span class=n>normalize</span> <span class=n>to</span> <span class=mi>0</span><span class=o>~</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>auto</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>h</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=p>::</span><span class=n>ostringstream</span> <span class=n>stringStream</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=n>auto</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>w</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=ne>int</span> <span class=n>color</span> <span class=o>=</span> <span class=n>img_data</span><span class=p>[</span><span class=n>i</span> <span class=o>*</span> <span class=n>w</span> <span class=o>+</span> <span class=n>j</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=o>//</span><span class=ne>int</span> <span class=n>red</span> <span class=o>=</span> <span class=p>((</span><span class=n>color</span> <span class=o>&amp;</span> <span class=mh>0x00FF0000</span><span class=p>)</span> <span class=o>&gt;&gt;</span> <span class=mi>16</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=o>//</span><span class=ne>int</span> <span class=n>green</span> <span class=o>=</span> <span class=p>((</span><span class=n>color</span> <span class=o>&amp;</span> <span class=mh>0x0000FF00</span><span class=p>)</span> <span class=o>&gt;&gt;</span> <span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=o>//</span><span class=ne>int</span> <span class=n>blue</span> <span class=o>=</span> <span class=n>color</span> <span class=o>&amp;</span> <span class=mh>0x000000FF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=o>//</span><span class=ne>float</span> <span class=n>grey</span> <span class=o>=</span> <span class=n>red</span> <span class=o>*</span> <span class=mf>0.3</span> <span class=o>+</span> <span class=n>green</span> <span class=o>*</span> <span class=mf>0.59</span> <span class=o>+</span> <span class=n>blue</span> <span class=o>*</span> <span class=mf>0.11</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=ne>float</span> <span class=n>grey</span> <span class=o>=</span> <span class=mf>0.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>color</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>grey</span> <span class=o>=</span> <span class=mf>1.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>input_data</span><span class=p>[</span><span class=n>i</span> <span class=o>*</span> <span class=n>w</span> <span class=o>+</span> <span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>grey</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=o>//</span><span class=n>alog</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>%f</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>grey</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=o>//</span><span class=n>alog</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>%d</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>color</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>color</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>color</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>stringStream</span> <span class=o>&lt;&lt;</span> <span class=n>color</span> <span class=o>&lt;&lt;</span> <span class=s2>&#34; &#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span><span class=n>alog</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>alog</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>stringStream</span><span class=o>.</span><span class=n>str</span><span class=p>()</span><span class=o>.</span><span class=n>c_str</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>caffe2</span><span class=p>::</span><span class=n>TensorCPU</span> <span class=n>input</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>input</span><span class=o>.</span><span class=n>Resize</span><span class=p>(</span><span class=n>std</span><span class=p>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=ne>int</span><span class=o>&gt;</span><span class=p>({</span><span class=mi>1</span><span class=p>,</span> <span class=n>IMG_C</span><span class=p>,</span> <span class=n>IMG_H</span><span class=p>,</span> <span class=n>IMG_W</span><span class=p>}));</span>
</span></span><span class=line><span class=cl>    <span class=n>memcpy</span><span class=p>(</span><span class=n>input</span><span class=o>.</span><span class=n>mutable_data</span><span class=o>&lt;</span><span class=ne>float</span><span class=o>&gt;</span><span class=p>(),</span> <span class=n>input_data</span><span class=p>,</span> <span class=n>INPUT_DATA_SIZE</span> <span class=o>*</span> <span class=n>sizeof</span><span class=p>(</span><span class=ne>float</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>caffe2</span><span class=p>::</span><span class=n>Predictor</span><span class=p>::</span><span class=n>TensorVector</span> <span class=n>input_vec</span><span class=p>{</span><span class=o>&amp;</span><span class=n>input</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=n>caffe2</span><span class=p>::</span><span class=n>Predictor</span><span class=p>::</span><span class=n>TensorVector</span> <span class=n>output_vec</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>_predictor</span><span class=o>-&gt;</span><span class=n>run</span><span class=p>(</span><span class=n>input_vec</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>output_vec</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>constexpr</span> <span class=ne>int</span> <span class=n>k</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=ne>float</span> <span class=nb>max</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=ne>int</span> <span class=n>max_index</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=n>Find</span> <span class=n>the</span> <span class=n>top</span><span class=o>-</span><span class=n>k</span> <span class=n>result</span> <span class=n>manually</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>output_vec</span><span class=o>.</span><span class=n>capacity</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=n>auto</span> <span class=n>output</span> <span class=p>:</span> <span class=n>output_vec</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=n>auto</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>output</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>();</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=p>(</span><span class=n>auto</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>k</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=n>output</span><span class=o>-&gt;</span><span class=n>template</span> <span class=n>data</span><span class=o>&lt;</span><span class=ne>float</span><span class=o>&gt;</span><span class=p>()[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=nb>max</span><span class=p>[</span><span class=n>j</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>for</span> <span class=p>(</span><span class=n>auto</span> <span class=n>_j</span> <span class=o>=</span> <span class=n>k</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=n>_j</span> <span class=o>&gt;</span> <span class=n>j</span><span class=p>;</span> <span class=o>--</span><span class=n>_j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=nb>max</span><span class=p>[</span><span class=n>_j</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=nb>max</span><span class=p>[</span><span class=n>_j</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                            <span class=n>max_index</span><span class=p>[</span><span class=n>_j</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>max_index</span><span class=p>[</span><span class=n>_j</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=nb>max</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>output</span><span class=o>-&gt;</span><span class=n>template</span> <span class=n>data</span><span class=o>&lt;</span><span class=ne>float</span><span class=o>&gt;</span><span class=p>()[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                        <span class=n>max_index</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=n>goto</span> <span class=n>skip</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=n>skip</span><span class=p>:;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=p>::</span><span class=n>ostringstream</span> <span class=n>stringStream</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>auto</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>k</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>stringStream</span> <span class=o>&lt;&lt;</span> <span class=n>max_index</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>&lt;&lt;</span> <span class=s2>&#34;: &#34;</span> <span class=o>&lt;&lt;</span> <span class=nb>max</span><span class=p>[</span><span class=n>j</span><span class=p>]</span><span class=o>*</span><span class=mi>100</span> <span class=o>&lt;&lt;</span> <span class=s2>&#34;%</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span>    <span class=k>if</span> <span class=p>(</span><span class=n>output_vec</span><span class=o>.</span><span class=n>capacity</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=o>//</span>        <span class=k>for</span> <span class=p>(</span><span class=n>auto</span> <span class=n>output</span><span class=p>:</span> <span class=n>output_vec</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=o>//</span>            <span class=k>for</span> <span class=p>(</span><span class=n>auto</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;</span><span class=n>output</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>();</span><span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=o>//</span>                <span class=n>stringStream</span> <span class=o>&lt;&lt;</span> <span class=n>output</span><span class=o>-&gt;</span><span class=n>template</span> <span class=n>data</span><span class=o>&lt;</span><span class=ne>float</span><span class=o>&gt;</span><span class=p>()[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;&lt;</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>//</span>            <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>//</span>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>//</span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>env</span><span class=o>-&gt;</span><span class=n>NewStringUTF</span><span class=p>(</span><span class=n>stringStream</span><span class=o>.</span><span class=n>str</span><span class=p>()</span><span class=o>.</span><span class=n>c_str</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><img src=/images/2018-04-29-001.gif width=240 height=427><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><p>  通过上面的Demo可以看出，通过MNIST数据训练出来的模型在实际运行的准确率还是很堪忧的。所以一个算法从实验室数据到实际应用还有很长的路要走，虽然最近应用于各个领域的深度学习模型层出不穷，测试数据也很好看，但是在实际应用过程中还有很多路要走。虽然DeepLearning已经表现出很强大的黑魔法属性，在实际应用过程中还是有很多工作要做，不然只能停留在Demo阶段。以本文的手写数字识别为例，实际过程的准确率与测试集上的准确率相差甚远，这时候就需要进行大量的优化工作。由于学习深度学习没多久，暂时只能根据以往在机器学习上的经验来进行优化，目前能想到的优化方向有：训练集与实际运行环境要一致、准备更多的训练集、深度另外的模型方法。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://lyapple2008.github.io/tags/android/>Android</a></li><li><a href=https://lyapple2008.github.io/tags/deeplearning/>DeepLearning</a></li></ul><nav class=paginav><a class=prev href=https://lyapple2008.github.io/posts/201808/2018-08-18-windows%E4%B8%8B%E8%BD%BD%E7%BC%96%E8%AF%91ffmpeg%E5%8A%A8%E6%80%81%E5%BA%93%E6%8C%87%E5%8C%97/><span class=title>« 上一页</span><br><span>Windows下载编译FFmpeg动态库指北</span>
</a><a class=next href=https://lyapple2008.github.io/posts/201803/2018-3-24-ffmpeg%E4%B8%ADavfilter%E6%A8%A1%E5%9D%97%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/><span class=title>下一页 »</span><br><span>FFmpeg中AVFilter模块实践指南</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Android端实现手写数字识别 on x" href="https://x.com/intent/tweet/?text=Android%e7%ab%af%e5%ae%9e%e7%8e%b0%e6%89%8b%e5%86%99%e6%95%b0%e5%ad%97%e8%af%86%e5%88%ab&amp;url=https%3a%2f%2flyapple2008.github.io%2fposts%2f201804%2f2018-04-29-android%25E7%25AB%25AF%25E5%25AE%259E%25E7%258E%25B0%25E6%2589%258B%25E5%2586%2599%25E6%2595%25B0%25E5%25AD%2597%25E8%25AF%2586%25E5%2588%25AB%2f&amp;hashtags=Android%2cDeepLearning"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Android端实现手写数字识别 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2flyapple2008.github.io%2fposts%2f201804%2f2018-04-29-android%25E7%25AB%25AF%25E5%25AE%259E%25E7%258E%25B0%25E6%2589%258B%25E5%2586%2599%25E6%2595%25B0%25E5%25AD%2597%25E8%25AF%2586%25E5%2588%25AB%2f&amp;title=Android%e7%ab%af%e5%ae%9e%e7%8e%b0%e6%89%8b%e5%86%99%e6%95%b0%e5%ad%97%e8%af%86%e5%88%ab&amp;summary=Android%e7%ab%af%e5%ae%9e%e7%8e%b0%e6%89%8b%e5%86%99%e6%95%b0%e5%ad%97%e8%af%86%e5%88%ab&amp;source=https%3a%2f%2flyapple2008.github.io%2fposts%2f201804%2f2018-04-29-android%25E7%25AB%25AF%25E5%25AE%259E%25E7%258E%25B0%25E6%2589%258B%25E5%2586%2599%25E6%2595%25B0%25E5%25AD%2597%25E8%25AF%2586%25E5%2588%25AB%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Android端实现手写数字识别 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2flyapple2008.github.io%2fposts%2f201804%2f2018-04-29-android%25E7%25AB%25AF%25E5%25AE%259E%25E7%258E%25B0%25E6%2589%258B%25E5%2586%2599%25E6%2595%25B0%25E5%25AD%2597%25E8%25AF%2586%25E5%2588%25AB%2f&title=Android%e7%ab%af%e5%ae%9e%e7%8e%b0%e6%89%8b%e5%86%99%e6%95%b0%e5%ad%97%e8%af%86%e5%88%ab"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Android端实现手写数字识别 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2flyapple2008.github.io%2fposts%2f201804%2f2018-04-29-android%25E7%25AB%25AF%25E5%25AE%259E%25E7%258E%25B0%25E6%2589%258B%25E5%2586%2599%25E6%2595%25B0%25E5%25AD%2597%25E8%25AF%2586%25E5%2588%25AB%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Android端实现手写数字识别 on whatsapp" href="https://api.whatsapp.com/send?text=Android%e7%ab%af%e5%ae%9e%e7%8e%b0%e6%89%8b%e5%86%99%e6%95%b0%e5%ad%97%e8%af%86%e5%88%ab%20-%20https%3a%2f%2flyapple2008.github.io%2fposts%2f201804%2f2018-04-29-android%25E7%25AB%25AF%25E5%25AE%259E%25E7%258E%25B0%25E6%2589%258B%25E5%2586%2599%25E6%2595%25B0%25E5%25AD%2597%25E8%25AF%2586%25E5%2588%25AB%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Android端实现手写数字识别 on telegram" href="https://telegram.me/share/url?text=Android%e7%ab%af%e5%ae%9e%e7%8e%b0%e6%89%8b%e5%86%99%e6%95%b0%e5%ad%97%e8%af%86%e5%88%ab&amp;url=https%3a%2f%2flyapple2008.github.io%2fposts%2f201804%2f2018-04-29-android%25E7%25AB%25AF%25E5%25AE%259E%25E7%258E%25B0%25E6%2589%258B%25E5%2586%2599%25E6%2595%25B0%25E5%25AD%2597%25E8%25AF%2586%25E5%2588%25AB%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Android端实现手写数字识别 on ycombinator" href="https://news.ycombinator.com/submitlink?t=Android%e7%ab%af%e5%ae%9e%e7%8e%b0%e6%89%8b%e5%86%99%e6%95%b0%e5%ad%97%e8%af%86%e5%88%ab&u=https%3a%2f%2flyapple2008.github.io%2fposts%2f201804%2f2018-04-29-android%25E7%25AB%25AF%25E5%25AE%259E%25E7%258E%25B0%25E6%2589%258B%25E5%2586%2599%25E6%2595%25B0%25E5%25AD%2597%25E8%25AF%2586%25E5%2588%25AB%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><section><h2>Comments</h2><div id=comments-utteranc></div></section><script type=text/javascript>function getCurrentTheme(){return document.documentElement.getAttribute("data-theme")||document.body.classList.contains("dark")?"dark":"light"}function loadUtterances(e=!1){const t=document.getElementById("comments-utteranc");if(t!==null){t.innerHTML="";const n=document.createElement("script");n.setAttribute("id","utteranc"),n.setAttribute("src","https://utteranc.es/client.js"),n.setAttribute("data-repo","lyapple2008/comment"),n.setAttribute("data-category","Announcements"),n.setAttribute("data-mapping","pathname"),n.setAttribute("data-reactions-enabled","1"),n.setAttribute("data-emit-metadata","0"),n.setAttribute("data-theme",e?"github-dark":"github-light"),n.setAttribute("data-issue-term","title"),n.setAttribute("crossorigin","anonymous"),n.setAttribute("async","true"),t.appendChild(n)}}const isDarkMode=getCurrentTheme()==="dark";loadUtterances(isDarkMode);const themeObserver=new MutationObserver(e=>{e.forEach(e=>{if(e.type==="attributes"&&e.attributeName==="class"){const e=getCurrentTheme()==="dark";loadUtterances(e),console.log(`changing theme`)}})});themeObserver.observe(document.body,{attributes:!0,attributeFilter:["class"]})</script></article></main><footer class=footer><span>See this site&rsquo;s source code <a href=https://github.com/lyapple2008/lyapple2008.github.io>here</a>, licensed under GPLv3 ·</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>