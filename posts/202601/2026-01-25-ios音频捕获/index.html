<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>iOS音频捕获 | BeYoung</title><meta name=keywords content="iOS开发,开发日志,双语字幕"><meta name=description content="
这篇是iOS双语字幕软件的开发日志，目标是在iOS端实现，在观看视频时，实时对播放的内容进行识别和翻译，显示双语字幕，用于打破外语视频内容观看门槛。"><meta name=author content="Marshall Liu"><link rel=canonical href=https://lyapple2008.github.io/posts/202601/2026-01-25-ios%E9%9F%B3%E9%A2%91%E6%8D%95%E8%8E%B7/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.2211ca3164be7830024f6aad2b3a2e520843a64f8f048445c3401c1249aa051d.css integrity="sha256-IhHKMWS+eDACT2qtKzouUghDpk+PBIRFw0AcEkmqBR0=" rel="preload stylesheet" as=style><link rel=icon href=https://lyapple2008.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://lyapple2008.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://lyapple2008.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://lyapple2008.github.io/apple-touch-icon.png><link rel=mask-icon href=https://lyapple2008.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://lyapple2008.github.io/posts/202601/2026-01-25-ios%E9%9F%B3%E9%A2%91%E6%8D%95%E8%8E%B7/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/katex.min.css integrity=sha384-bYdxxUwYipFNohQlHt0bjN/LCpueqWz13HufFEV1SUatKs1cm4L6fFgCi1jT643X crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/katex.min.js integrity=sha384-Qsn9KnoKISj6dI8g7p1HBlNpVx0I8p1SvlwOldgi3IorMle61nQy4zEahWYtljaz crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script><script type=module>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({
    startOnLoad: true,
    theme: 'default',
    securityLevel: 'loose'
  });
</script><meta property="og:url" content="https://lyapple2008.github.io/posts/202601/2026-01-25-ios%E9%9F%B3%E9%A2%91%E6%8D%95%E8%8E%B7/"><meta property="og:site_name" content="BeYoung"><meta property="og:title" content="iOS音频捕获"><meta property="og:description" content=" 这篇是iOS双语字幕软件的开发日志，目标是在iOS端实现，在观看视频时，实时对播放的内容进行识别和翻译，显示双语字幕，用于打破外语视频内容观看门槛。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-01-25T07:52:25+08:00"><meta property="article:modified_time" content="2026-01-25T07:52:25+08:00"><meta property="article:tag" content="IOS开发"><meta property="article:tag" content="开发日志"><meta property="article:tag" content="双语字幕"><meta property="og:image" content="https://lyapple2008.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://lyapple2008.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="iOS音频捕获"><meta name=twitter:description content="
这篇是iOS双语字幕软件的开发日志，目标是在iOS端实现，在观看视频时，实时对播放的内容进行识别和翻译，显示双语字幕，用于打破外语视频内容观看门槛。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://lyapple2008.github.io/posts/"},{"@type":"ListItem","position":2,"name":"iOS音频捕获","item":"https://lyapple2008.github.io/posts/202601/2026-01-25-ios%E9%9F%B3%E9%A2%91%E6%8D%95%E8%8E%B7/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"iOS音频捕获","name":"iOS音频捕获","description":" 这篇是iOS双语字幕软件的开发日志，目标是在iOS端实现，在观看视频时，实时对播放的内容进行识别和翻译，显示双语字幕，用于打破外语视频内容观看门槛。\n","keywords":["iOS开发","开发日志","双语字幕"],"articleBody":" 这篇是iOS双语字幕软件的开发日志，目标是在iOS端实现，在观看视频时，实时对播放的内容进行识别和翻译，显示双语字幕，用于打破外语视频内容观看门槛。\n模块流程 graph LR A[捕获系统播放音频] --\u003e B[语音识别ASR] B --\u003e C[语言翻译] B --\u003e D[双语字幕] C --\u003e D iOS音频捕获与数据共享 本文介绍iOS系统音频捕获的实现方案，使用Broadcast Upload Extension捕获系统播放的音频，并通过App Group与主应用共享数据。\n目录 一、系统音频捕获 Broadcast Upload Extension配置 启动与关闭 音频格式转换 二、Extension与主应用数据共享 App Group配置 数据读写实现 Darwin通知 一、系统音频捕获 iOS系统出于安全和隐私考虑，不允许应用直接捕获系统音频（如视频播放、音乐等，使用通话模式的APP播放的声音捕获不到）。必须使用Broadcast Upload Extension，通过屏幕录制的形式获取音频数据。\nBroadcast Upload Extension配置 要让Extension收到ReplayKit的数据，必须同时满足：\n工程里有Broadcast Upload Extension target 主App用系统UI启动broadcast Extension的Info.plist / Capabilities / 类继承全部正确 创建步骤：\n在Xcode中新建Extension类型中选择Broadcast Upload Extension\n配置Info.plist：\n1 2 3 4 5 6 7 NSExtension NSExtensionPointIdentifier com.apple.broadcast-services-upload NSExtensionPrincipalClass $(PRODUCT_MODULE_NAME).SampleHandler 主App配置UIBackgroundModes： 1 2 3 4 UIBackgroundModes audio 注意：未配置audio可能导致音频接收不到或屏幕锁定后Extension被暂停。\n启动与关闭 Broadcast upload extension不能在代码中直接启动，只能由系统UI触发。Extension只能自己调用finishBroadcastWithError关闭，主App只能\"间接控制\"关闭。\n1 2 3 4 5 6 let picker = RPSystemBroadcastPickerView( frame: CGRect(x: 0, y: 0, width: 44, height: 44) ) picker.preferredExtension = \"com.xxx.broadcast\" picker.showsMicrophoneButton = true view.addSubview(picker) 音频格式转换 语音识别引擎接收的音频格式需要是16kHz单声道音频，因此这里需要先进行格式转换。这里需要注意是，并没有官方文档说ReplayKit回调的数据格式类型是怎样的，因此这里需要兼容各种格式。\n格式检测与提取：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 override func processSampleBuffer(_ sampleBuffer: CMSampleBuffer, with sampleBufferType: RPSampleBufferType) { guard case .audioApp = sampleBufferType else { return } guard let formatDescription = CMSampleBufferGetFormatDescription(sampleBuffer), let streamDesc = CMAudioFormatDescriptionGetStreamBasicDescription(formatDescription)?.pointee else { return } let inputSampleRate = streamDesc.mSampleRate let channelCount = Int(streamDesc.mChannelsPerFrame) let bitsPerChannel = streamDesc.mBitsPerChannel let formatFlags = streamDesc.mFormatFlags let isFloat = (formatFlags \u0026 kAudioFormatFlagIsFloat) != 0 let isNonInterleaved = (formatFlags \u0026 kAudioFormatFlagIsNonInterleaved) != 0 let isBigEndian = (formatFlags \u0026 kAudioFormatFlagIsBigEndian) != 0 // 提取音频数据... } 完整的音频处理实现：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 private let targetSampleRate: Double = 16000.0 /// 处理音频样本buffer private func processAudioBuffer(_ sampleBuffer: CMSampleBuffer, source: String) { guard let formatDescription = CMSampleBufferGetFormatDescription(sampleBuffer), let streamDesc = CMAudioFormatDescriptionGetStreamBasicDescription(formatDescription)?.pointee else { return } let inputSampleRate = streamDesc.mSampleRate let channelCount = Int(streamDesc.mChannelsPerFrame) let bitsPerChannel = streamDesc.mBitsPerChannel let formatFlags = streamDesc.mFormatFlags let isFloat = (formatFlags \u0026 kAudioFormatFlagIsFloat) != 0 let isNonInterleaved = (formatFlags \u0026 kAudioFormatFlagIsNonInterleaved) != 0 let isBigEndian = (formatFlags \u0026 kAudioFormatFlagIsBigEndian) != 0 // 获取 AudioBufferList var audioBufferList = AudioBufferList() var blockBuffer: CMBlockBuffer? let status = CMSampleBufferGetAudioBufferListWithRetainedBlockBuffer( sampleBuffer, bufferListSizeNeededOut: nil, bufferListOut: \u0026audioBufferList, bufferListSize: MemoryLayout\u003cAudioBufferList\u003e.size, blockBufferAllocator: nil, blockBufferMemoryAllocator: nil, flags: kCMSampleBufferFlag_AudioBufferList_Assure16ByteAlignment, blockBufferOut: \u0026blockBuffer ) guard status == noErr else { return } let audioBufferListPointer = UnsafeMutableAudioBufferListPointer( UnsafeMutablePointer\u003cAudioBufferList\u003e.allocate(capacity: 1) ) defer { audioBufferListPointer.unsafeMutablePointer.deallocate() } let numBuffers = audioBufferListPointer.count let frameCount = CMSampleBufferGetNumSamples(sampleBuffer) var floatSamples: [Float] = [] // 处理非交错格式 if isNonInterleaved { var channelData: [[Float]] = [] for bufferIndex in 0..\u003cnumBuffers { let buffer = audioBufferListPointer[bufferIndex] guard let data = buffer.mData else { continue } let dataByteSize = Int(buffer.mDataByteSize) var channelSamples: [Float] = [] if isFloat \u0026\u0026 bitsPerChannel == 32 { let floatPtr = data.assumingMemoryBound(to: Float.self) let count = dataByteSize / MemoryLayout\u003cFloat\u003e.size for i in 0..\u003ccount { var value = floatPtr[i] if isBigEndian { value = Float(bitPattern: value.bitPattern.bigEndian) } channelSamples.append(value) } } else if bitsPerChannel == 16 { let int16Ptr = data.assumingMemoryBound(to: Int16.self) let count = dataByteSize / MemoryLayout\u003cInt16\u003e.size for i in 0..\u003ccount { var value = int16Ptr[i] if isBigEndian { value = value.bigEndian } channelSamples.append(Float(value) / 32768.0) } } channelData.append(channelSamples) } // 混音为单声道 if let firstChannel = channelData.first { if channelData.count == 1 { floatSamples = firstChannel } else { for i in 0..\u003cfirstChannel.count { var sum: Float = 0 for ch in channelData where i \u003c ch.count { sum += ch[i] } floatSamples.append(sum / Float(channelData.count)) } } } } else { // 交错格式处理... } // 重采样到16kHz if inputSampleRate != targetSampleRate { floatSamples = resample(floatSamples, from: inputSampleRate, to: targetSampleRate) } sharedBuffer.writeAudioSamples(floatSamples) } /// 使用AVAudioConverter重采样 private func resample(_ samples: [Float], from inputRate: Double, to outputRate: Double) -\u003e [Float] { guard inputRate \u003e 0 \u0026\u0026 outputRate \u003e 0, inputRate != outputRate, !samples.isEmpty else { return samples } guard let inputFormat = AVAudioFormat( commonFormat: .pcmFormatFloat32, sampleRate: inputRate, channels: 1, interleaved: false ), let outputFormat = AVAudioFormat( commonFormat: .pcmFormatFloat32, sampleRate: outputRate, channels: 1, interleaved: false ), let converter = AVAudioConverter(from: inputFormat, to: outputFormat) else { return samples } guard let inputBuffer = AVAudioPCMBuffer(pcmFormat: inputFormat, frameCapacity: AVAudioFrameCount(samples.count)), let outputBuffer = AVAudioPCMBuffer(pcmFormat: outputFormat) else { return samples } inputBuffer.frameLength = AVAudioFrameCount(samples.count) let inputData = inputBuffer.floatChannelData! for i in 0..\u003csamples.count { inputData[0][i] = samples[i] } let ratio = outputRate / inputRate let outputFrameCount = Int(ceil(Double(samples.count) * ratio)) outputBuffer.frameCapacity = AVAudioFrameCount(outputFrameCount) var error: NSError? let status = converter.convert(to: outputBuffer, error: \u0026error) { _, outStatus in outStatus.pointee = .haveData return inputBuffer } guard status == .haveData, error == nil else { return samples } let outputData = outputBuffer.floatChannelData! let outputLength = Int(outputBuffer.frameLength) return (0..\u003coutputLength).map { outputData[0][$0] } } 实现要点：\n内存安全：使用 UnsafeMutableAudioBufferListPointer 和 defer 确保内存正确释放 多格式支持：支持 Float32、Int16、Int32 格式 字节序处理：支持大端和小端字节序 非交错格式：正确处理每个通道独立 buffer 的格式 混音：立体声自动混音为单声道 高质量重采样：使用系统 AVAudioConverter 二、Extension与主应用数据共享 Broadcast Extension与主应用运行在不同进程，涉及到进程间通信，这里选择使用实现比较简单的App Group共享容器进行数据交换。\nApp Group配置 Entitlements配置：\n1 2 3 4 com.apple.security.application-groups group.com.xxx.shared 需要在Apple Developer Portal创建App Group，并在XCode中为两个target启用。\n数据读写实现 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 class AudioSharedBuffer { static let appGroupId = \"group.com.xxx.shared\" private let sharedContainerURL = FileManager.default.containerURL( forSecurityApplicationGroupIdentifier: Self.appGroupId ) // Extension写入处理后的音频 func writeAudioSamples(_ samples: [Float]) { guard let url = sharedContainerURL?.appendingPathComponent(\"audio.raw\") else { return } let data = samples.withUnsafeBufferPointer { Data(buffer: $0) } if FileManager.default.fileExists(atPath: url.path) { let handle = try? FileHandle(forWritingTo: url) handle?.seekToEndOfFile() handle?.write(data) handle?.closeFile() } else { try? data.write(to: url) } postDarwinNotification(\"com.xxx.newAudioData\") } // 主应用读取音频 func readAudioSamples() -\u003e [Float]? { guard let url = sharedContainerURL?.appendingPathComponent(\"audio.raw\"), FileManager.default.fileExists(atPath: url.path) else { return nil } let data = try? Data(contentsOf: url) try? FileManager.default.removeItem(at: url) let floatCount = data?.count ?? 0 / MemoryLayout\u003cFloat\u003e.size var samples = [Float](repeating: 0, count: floatCount) data?.copyBytes(to: samples.withUnsafeMutableBufferPointer { $0 }) return samples } private func postDarwinNotification(_ name: String) { let center = CFNotificationCenterGetDarwinNotifyCenter() CFNotificationCenterPostNotification(center, CFNotificationName(name as CFString), nil, nil, true) } } Darwin通知 Extension写入数据后发送Darwin通知，主应用监听后立即读取：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func startListening() { CFNotificationCenterAddObserver( CFNotificationCenterGetDarwinNotifyCenter(), Unmanaged.passUnretained(self).toOpaque(), { _, observer, _, _, _ in guard let observer = observer else { return } let selfPtr = Unmanaged\u003cYourClass\u003e.fromOpaque(observer).takeUnretainedValue() if let samples = selfPtr.audioBuffer.readAudioSamples() { selfPtr.onAudioReceived?(samples) } }, \"com.xxx.newAudioData\" as CFString, nil, .deliverImmediately ) } SampleHandler完整示例 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 class SampleHandler: RPBroadcastSampleHandler { private let sharedBuffer = AudioSharedBuffer() private let targetSampleRate: Double = 16000.0 override func broadcastStarted(withSetupInfo setupInfo: [String : NSObject]?) { sharedBuffer.clearAudioData() } override func broadcastPaused() {} override func broadcastResumed() {} override func broadcastFinished() {} override func processSampleBuffer(_ sampleBuffer: CMSampleBuffer, with sampleBufferType: RPSampleBufferType) { switch sampleBufferType { case .audioApp: // 处理应用音频（系统播放的音频） let samples = convertTo16kMono(sampleBuffer) sharedBuffer.writeAudioSamples(samples) case .audioMic: // 忽略麦克风音频 break case .video: // 忽略视频 break } } } ","wordCount":"2395","inLanguage":"zh","image":"https://lyapple2008.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2026-01-25T07:52:25+08:00","dateModified":"2026-01-25T07:52:25+08:00","author":{"@type":"Person","name":"Marshall Liu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://lyapple2008.github.io/posts/202601/2026-01-25-ios%E9%9F%B3%E9%A2%91%E6%8D%95%E8%8E%B7/"},"publisher":{"@type":"Organization","name":"BeYoung","logo":{"@type":"ImageObject","url":"https://lyapple2008.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://lyapple2008.github.io/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://lyapple2008.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://lyapple2008.github.io/search/ title=搜索><span>搜索</span></a></li><li><a href=https://lyapple2008.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=https://lyapple2008.github.io/about_me/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://lyapple2008.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://lyapple2008.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">iOS音频捕获</h1><div class=post-meta><span title='2026-01-25 07:52:25 +0800 CST'>一月 25, 2026</span>&nbsp;·&nbsp;5 分钟&nbsp;·&nbsp;2395 字&nbsp;·&nbsp;Marshall Liu</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#模块流程>模块流程</a></li></ul></li></ul><ul><li><a href=#目录>目录</a></li><li><a href=#一系统音频捕获>一、系统音频捕获</a><ul><li><a href=#broadcast-upload-extension配置>Broadcast Upload Extension配置</a></li><li><a href=#启动与关闭>启动与关闭</a></li><li><a href=#音频格式转换>音频格式转换</a></li></ul></li><li><a href=#二extension与主应用数据共享>二、Extension与主应用数据共享</a><ul><li><a href=#app-group配置>App Group配置</a></li><li><a href=#数据读写实现>数据读写实现</a></li><li><a href=#darwin通知>Darwin通知</a></li></ul></li><li><a href=#samplehandler完整示例>SampleHandler完整示例</a></li></ul></nav></div></details></div><div class=post-content><blockquote><p>这篇是iOS双语字幕软件的开发日志，目标是在iOS端实现，在观看视频时，实时对播放的内容进行识别和翻译，显示双语字幕，用于打破外语视频内容观看门槛。</p></blockquote><h3 id=模块流程>模块流程<a hidden class=anchor aria-hidden=true href=#模块流程>#</a></h3><div class=mermaid>graph LR
A[捕获系统播放音频] --> B[语音识别ASR]
B --> C[语言翻译]
B --> D[双语字幕]
C --> D</div><h1 id=ios音频捕获与数据共享>iOS音频捕获与数据共享<a hidden class=anchor aria-hidden=true href=#ios音频捕获与数据共享>#</a></h1><p>本文介绍iOS系统音频捕获的实现方案，使用Broadcast Upload Extension捕获系统播放的音频，并通过App Group与主应用共享数据。</p><h2 id=目录>目录<a hidden class=anchor aria-hidden=true href=#目录>#</a></h2><ul><li><a href=/posts/202601/2026-01-25-ios%E9%9F%B3%E9%A2%91%E6%8D%95%E8%8E%B7/#%e4%b8%80%e7%b3%bb%e7%bb%9f%e9%9f%b3%e9%a2%91%e6%8d%95%e8%8e%b7>一、系统音频捕获</a><ul><li><a href=/posts/202601/2026-01-25-ios%E9%9F%B3%E9%A2%91%E6%8D%95%E8%8E%B7/#broadcast-upload-extension%e9%85%8d%e7%bd%ae>Broadcast Upload Extension配置</a></li><li><a href=/posts/202601/2026-01-25-ios%E9%9F%B3%E9%A2%91%E6%8D%95%E8%8E%B7/#%e5%90%af%e5%8a%a8%e4%b8%8e%e5%85%b3%e9%97%ad>启动与关闭</a></li><li><a href=/posts/202601/2026-01-25-ios%E9%9F%B3%E9%A2%91%E6%8D%95%E8%8E%B7/#%e9%9f%b3%e9%a2%91%e6%a0%bc%e5%bc%8f%e8%bd%ac%e6%8d%a2>音频格式转换</a></li></ul></li><li><a href=/posts/202601/2026-01-25-ios%E9%9F%B3%E9%A2%91%E6%8D%95%E8%8E%B7/#%e4%ba%8cextension%e4%b8%8e%e4%b8%bb%e5%ba%94%e7%94%a8%e6%95%b0%e6%8d%ae%e5%85%b1%e4%ba%ab>二、Extension与主应用数据共享</a><ul><li><a href=/posts/202601/2026-01-25-ios%E9%9F%B3%E9%A2%91%E6%8D%95%E8%8E%B7/#app-group%e9%85%8d%e7%bd%ae>App Group配置</a></li><li><a href=/posts/202601/2026-01-25-ios%E9%9F%B3%E9%A2%91%E6%8D%95%E8%8E%B7/#%e6%95%b0%e6%8d%ae%e8%af%bb%e5%86%99%e5%ae%9e%e7%8e%b0>数据读写实现</a></li><li><a href=/posts/202601/2026-01-25-ios%E9%9F%B3%E9%A2%91%E6%8D%95%E8%8E%B7/#darwin%e9%80%9a%e7%9f%a5>Darwin通知</a></li></ul></li></ul><hr><h2 id=一系统音频捕获>一、系统音频捕获<a hidden class=anchor aria-hidden=true href=#一系统音频捕获>#</a></h2><p>iOS系统出于安全和隐私考虑，<strong>不允许应用直接捕获系统音频</strong>（如视频播放、音乐等，使用通话模式的APP播放的声音捕获不到）。必须使用Broadcast Upload Extension，通过屏幕录制的形式获取音频数据。</p><h3 id=broadcast-upload-extension配置>Broadcast Upload Extension配置<a hidden class=anchor aria-hidden=true href=#broadcast-upload-extension配置>#</a></h3><p>要让Extension收到ReplayKit的数据，必须同时满足：</p><ol><li>工程里有Broadcast Upload Extension target</li><li>主App用系统UI启动broadcast</li><li>Extension的Info.plist / Capabilities / 类继承全部正确</li></ol><p><strong>创建步骤：</strong></p><ol><li><p>在Xcode中新建Extension类型中选择Broadcast Upload Extension</p></li><li><p>配置Info.plist：</p></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;key&gt;</span>NSExtension<span class=nt>&lt;/key&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dict&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;key&gt;</span>NSExtensionPointIdentifier<span class=nt>&lt;/key&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;string&gt;</span>com.apple.broadcast-services-upload<span class=nt>&lt;/string&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;key&gt;</span>NSExtensionPrincipalClass<span class=nt>&lt;/key&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;string&gt;</span>$(PRODUCT_MODULE_NAME).SampleHandler<span class=nt>&lt;/string&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dict&gt;</span></span></span></code></pre></td></tr></table></div></div><ol start=3><li>主App配置UIBackgroundModes：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;key&gt;</span>UIBackgroundModes<span class=nt>&lt;/key&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;array&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;string&gt;</span>audio<span class=nt>&lt;/string&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/array&gt;</span></span></span></code></pre></td></tr></table></div></div><p><strong>注意</strong>：未配置audio可能导致音频接收不到或屏幕锁定后Extension被暂停。</p><h3 id=启动与关闭>启动与关闭<a hidden class=anchor aria-hidden=true href=#启动与关闭>#</a></h3><p>Broadcast upload extension不能在代码中直接启动，只能由系统UI触发。Extension只能自己调用<code>finishBroadcastWithError</code>关闭，主App只能"间接控制"关闭。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-swift data-lang=swift><span class=line><span class=cl><span class=kd>let</span> <span class=nv>picker</span> <span class=p>=</span> <span class=n>RPSystemBroadcastPickerView</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>frame</span><span class=p>:</span> <span class=n>CGRect</span><span class=p>(</span><span class=n>x</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=n>y</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=n>width</span><span class=p>:</span> <span class=mi>44</span><span class=p>,</span> <span class=n>height</span><span class=p>:</span> <span class=mi>44</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>picker</span><span class=p>.</span><span class=n>preferredExtension</span> <span class=p>=</span> <span class=s>&#34;com.xxx.broadcast&#34;</span>
</span></span><span class=line><span class=cl><span class=n>picker</span><span class=p>.</span><span class=n>showsMicrophoneButton</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=n>view</span><span class=p>.</span><span class=n>addSubview</span><span class=p>(</span><span class=n>picker</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><h3 id=音频格式转换>音频格式转换<a hidden class=anchor aria-hidden=true href=#音频格式转换>#</a></h3><p>语音识别引擎接收的音频格式需要是16kHz单声道音频，因此这里需要先进行格式转换。这里需要注意是，并没有官方文档说ReplayKit回调的数据格式类型是怎样的，因此这里需要兼容各种格式。</p><p><strong>格式检测与提取：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-swift data-lang=swift><span class=line><span class=cl><span class=kr>override</span> <span class=kd>func</span> <span class=nf>processSampleBuffer</span><span class=p>(</span><span class=kc>_</span> <span class=n>sampleBuffer</span><span class=p>:</span> <span class=n>CMSampleBuffer</span><span class=p>,</span> <span class=n>with</span> <span class=n>sampleBufferType</span><span class=p>:</span> <span class=n>RPSampleBufferType</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>guard</span> <span class=k>case</span> <span class=p>.</span><span class=n>audioApp</span> <span class=p>=</span> <span class=n>sampleBufferType</span> <span class=k>else</span> <span class=p>{</span> <span class=k>return</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>guard</span> <span class=kd>let</span> <span class=nv>formatDescription</span> <span class=p>=</span> <span class=n>CMSampleBufferGetFormatDescription</span><span class=p>(</span><span class=n>sampleBuffer</span><span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=kd>let</span> <span class=nv>streamDesc</span> <span class=p>=</span> <span class=n>CMAudioFormatDescriptionGetStreamBasicDescription</span><span class=p>(</span><span class=n>formatDescription</span><span class=p>)?.</span><span class=n>pointee</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>inputSampleRate</span> <span class=p>=</span> <span class=n>streamDesc</span><span class=p>.</span><span class=n>mSampleRate</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>channelCount</span> <span class=p>=</span> <span class=nb>Int</span><span class=p>(</span><span class=n>streamDesc</span><span class=p>.</span><span class=n>mChannelsPerFrame</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>bitsPerChannel</span> <span class=p>=</span> <span class=n>streamDesc</span><span class=p>.</span><span class=n>mBitsPerChannel</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>formatFlags</span> <span class=p>=</span> <span class=n>streamDesc</span><span class=p>.</span><span class=n>mFormatFlags</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>isFloat</span> <span class=p>=</span> <span class=p>(</span><span class=n>formatFlags</span> <span class=o>&amp;</span> <span class=n>kAudioFormatFlagIsFloat</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>isNonInterleaved</span> <span class=p>=</span> <span class=p>(</span><span class=n>formatFlags</span> <span class=o>&amp;</span> <span class=n>kAudioFormatFlagIsNonInterleaved</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>isBigEndian</span> <span class=p>=</span> <span class=p>(</span><span class=n>formatFlags</span> <span class=o>&amp;</span> <span class=n>kAudioFormatFlagIsBigEndian</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 提取音频数据...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p><strong>完整的音频处理实现：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-swift data-lang=swift><span class=line><span class=cl><span class=kd>private</span> <span class=kd>let</span> <span class=nv>targetSampleRate</span><span class=p>:</span> <span class=nb>Double</span> <span class=p>=</span> <span class=mf>16000.0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>/// 处理音频样本buffer</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>func</span> <span class=nf>processAudioBuffer</span><span class=p>(</span><span class=kc>_</span> <span class=n>sampleBuffer</span><span class=p>:</span> <span class=n>CMSampleBuffer</span><span class=p>,</span> <span class=n>source</span><span class=p>:</span> <span class=nb>String</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>guard</span> <span class=kd>let</span> <span class=nv>formatDescription</span> <span class=p>=</span> <span class=n>CMSampleBufferGetFormatDescription</span><span class=p>(</span><span class=n>sampleBuffer</span><span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=kd>let</span> <span class=nv>streamDesc</span> <span class=p>=</span> <span class=n>CMAudioFormatDescriptionGetStreamBasicDescription</span><span class=p>(</span><span class=n>formatDescription</span><span class=p>)?.</span><span class=n>pointee</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>inputSampleRate</span> <span class=p>=</span> <span class=n>streamDesc</span><span class=p>.</span><span class=n>mSampleRate</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>channelCount</span> <span class=p>=</span> <span class=nb>Int</span><span class=p>(</span><span class=n>streamDesc</span><span class=p>.</span><span class=n>mChannelsPerFrame</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>bitsPerChannel</span> <span class=p>=</span> <span class=n>streamDesc</span><span class=p>.</span><span class=n>mBitsPerChannel</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>formatFlags</span> <span class=p>=</span> <span class=n>streamDesc</span><span class=p>.</span><span class=n>mFormatFlags</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>isFloat</span> <span class=p>=</span> <span class=p>(</span><span class=n>formatFlags</span> <span class=o>&amp;</span> <span class=n>kAudioFormatFlagIsFloat</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>isNonInterleaved</span> <span class=p>=</span> <span class=p>(</span><span class=n>formatFlags</span> <span class=o>&amp;</span> <span class=n>kAudioFormatFlagIsNonInterleaved</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>isBigEndian</span> <span class=p>=</span> <span class=p>(</span><span class=n>formatFlags</span> <span class=o>&amp;</span> <span class=n>kAudioFormatFlagIsBigEndian</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取 AudioBufferList</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nv>audioBufferList</span> <span class=p>=</span> <span class=n>AudioBufferList</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nv>blockBuffer</span><span class=p>:</span> <span class=n>CMBlockBuffer</span><span class=p>?</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>status</span> <span class=p>=</span> <span class=n>CMSampleBufferGetAudioBufferListWithRetainedBlockBuffer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>sampleBuffer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>bufferListSizeNeededOut</span><span class=p>:</span> <span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>bufferListOut</span><span class=p>:</span> <span class=p>&amp;</span><span class=n>audioBufferList</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>bufferListSize</span><span class=p>:</span> <span class=n>MemoryLayout</span><span class=p>&lt;</span><span class=n>AudioBufferList</span><span class=p>&gt;.</span><span class=n>size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>blockBufferAllocator</span><span class=p>:</span> <span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>blockBufferMemoryAllocator</span><span class=p>:</span> <span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>flags</span><span class=p>:</span> <span class=n>kCMSampleBufferFlag_AudioBufferList_Assure16ByteAlignment</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>blockBufferOut</span><span class=p>:</span> <span class=p>&amp;</span><span class=n>blockBuffer</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>guard</span> <span class=n>status</span> <span class=p>==</span> <span class=n>noErr</span> <span class=k>else</span> <span class=p>{</span> <span class=k>return</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>audioBufferListPointer</span> <span class=p>=</span> <span class=n>UnsafeMutableAudioBufferListPointer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nb>UnsafeMutablePointer</span><span class=p>&lt;</span><span class=n>AudioBufferList</span><span class=p>&gt;.</span><span class=n>allocate</span><span class=p>(</span><span class=n>capacity</span><span class=p>:</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>audioBufferListPointer</span><span class=p>.</span><span class=n>unsafeMutablePointer</span><span class=p>.</span><span class=n>deallocate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>numBuffers</span> <span class=p>=</span> <span class=n>audioBufferListPointer</span><span class=p>.</span><span class=bp>count</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>frameCount</span> <span class=p>=</span> <span class=n>CMSampleBufferGetNumSamples</span><span class=p>(</span><span class=n>sampleBuffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nv>floatSamples</span><span class=p>:</span> <span class=p>[</span><span class=nb>Float</span><span class=p>]</span> <span class=p>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 处理非交错格式</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>isNonInterleaved</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nv>channelData</span><span class=p>:</span> <span class=p>[[</span><span class=nb>Float</span><span class=p>]]</span> <span class=p>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>bufferIndex</span> <span class=k>in</span> <span class=mf>0.</span><span class=p>.&lt;</span><span class=n>numBuffers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>let</span> <span class=nv>buffer</span> <span class=p>=</span> <span class=n>audioBufferListPointer</span><span class=p>[</span><span class=n>bufferIndex</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>guard</span> <span class=kd>let</span> <span class=nv>data</span> <span class=p>=</span> <span class=n>buffer</span><span class=p>.</span><span class=n>mData</span> <span class=k>else</span> <span class=p>{</span> <span class=k>continue</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kd>let</span> <span class=nv>dataByteSize</span> <span class=p>=</span> <span class=nb>Int</span><span class=p>(</span><span class=n>buffer</span><span class=p>.</span><span class=n>mDataByteSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=kd>var</span> <span class=nv>channelSamples</span><span class=p>:</span> <span class=p>[</span><span class=nb>Float</span><span class=p>]</span> <span class=p>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>isFloat</span> <span class=o>&amp;&amp;</span> <span class=n>bitsPerChannel</span> <span class=p>==</span> <span class=mi>32</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kd>let</span> <span class=nv>floatPtr</span> <span class=p>=</span> <span class=n>data</span><span class=p>.</span><span class=n>assumingMemoryBound</span><span class=p>(</span><span class=n>to</span><span class=p>:</span> <span class=nb>Float</span><span class=p>.</span><span class=kc>self</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=kd>let</span> <span class=nv>count</span> <span class=p>=</span> <span class=n>dataByteSize</span> <span class=o>/</span> <span class=n>MemoryLayout</span><span class=p>&lt;</span><span class=nb>Float</span><span class=p>&gt;.</span><span class=n>size</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>i</span> <span class=k>in</span> <span class=mf>0.</span><span class=p>.&lt;</span><span class=bp>count</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=kd>var</span> <span class=nv>value</span> <span class=p>=</span> <span class=n>floatPtr</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>isBigEndian</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>value</span> <span class=p>=</span> <span class=nb>Float</span><span class=p>(</span><span class=n>bitPattern</span><span class=p>:</span> <span class=n>value</span><span class=p>.</span><span class=n>bitPattern</span><span class=p>.</span><span class=n>bigEndian</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=n>channelSamples</span><span class=p>.</span><span class=n>append</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=n>bitsPerChannel</span> <span class=p>==</span> <span class=mi>16</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kd>let</span> <span class=nv>int16Ptr</span> <span class=p>=</span> <span class=n>data</span><span class=p>.</span><span class=n>assumingMemoryBound</span><span class=p>(</span><span class=n>to</span><span class=p>:</span> <span class=nb>Int16</span><span class=p>.</span><span class=kc>self</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=kd>let</span> <span class=nv>count</span> <span class=p>=</span> <span class=n>dataByteSize</span> <span class=o>/</span> <span class=n>MemoryLayout</span><span class=p>&lt;</span><span class=nb>Int16</span><span class=p>&gt;.</span><span class=n>size</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>i</span> <span class=k>in</span> <span class=mf>0.</span><span class=p>.&lt;</span><span class=bp>count</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=kd>var</span> <span class=nv>value</span> <span class=p>=</span> <span class=n>int16Ptr</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>isBigEndian</span> <span class=p>{</span> <span class=n>value</span> <span class=p>=</span> <span class=n>value</span><span class=p>.</span><span class=n>bigEndian</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=n>channelSamples</span><span class=p>.</span><span class=n>append</span><span class=p>(</span><span class=nb>Float</span><span class=p>(</span><span class=n>value</span><span class=p>)</span> <span class=o>/</span> <span class=mf>32768.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>channelData</span><span class=p>.</span><span class=n>append</span><span class=p>(</span><span class=n>channelSamples</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 混音为单声道</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=kd>let</span> <span class=nv>firstChannel</span> <span class=p>=</span> <span class=n>channelData</span><span class=p>.</span><span class=bp>first</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>channelData</span><span class=p>.</span><span class=bp>count</span> <span class=p>==</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>floatSamples</span> <span class=p>=</span> <span class=n>firstChannel</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>i</span> <span class=k>in</span> <span class=mf>0.</span><span class=p>.&lt;</span><span class=n>firstChannel</span><span class=p>.</span><span class=bp>count</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=kd>var</span> <span class=nv>sum</span><span class=p>:</span> <span class=nb>Float</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> <span class=n>ch</span> <span class=k>in</span> <span class=n>channelData</span> <span class=k>where</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>ch</span><span class=p>.</span><span class=bp>count</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>sum</span> <span class=o>+=</span> <span class=n>ch</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=n>floatSamples</span><span class=p>.</span><span class=n>append</span><span class=p>(</span><span class=n>sum</span> <span class=o>/</span> <span class=nb>Float</span><span class=p>(</span><span class=n>channelData</span><span class=p>.</span><span class=bp>count</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 交错格式处理...</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 重采样到16kHz</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>inputSampleRate</span> <span class=o>!=</span> <span class=n>targetSampleRate</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>floatSamples</span> <span class=p>=</span> <span class=n>resample</span><span class=p>(</span><span class=n>floatSamples</span><span class=p>,</span> <span class=n>from</span><span class=p>:</span> <span class=n>inputSampleRate</span><span class=p>,</span> <span class=n>to</span><span class=p>:</span> <span class=n>targetSampleRate</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sharedBuffer</span><span class=p>.</span><span class=n>writeAudioSamples</span><span class=p>(</span><span class=n>floatSamples</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>/// 使用AVAudioConverter重采样</span>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kd>func</span> <span class=nf>resample</span><span class=p>(</span><span class=kc>_</span> <span class=n>samples</span><span class=p>:</span> <span class=p>[</span><span class=nb>Float</span><span class=p>],</span> <span class=n>from</span> <span class=n>inputRate</span><span class=p>:</span> <span class=nb>Double</span><span class=p>,</span> <span class=n>to</span> <span class=n>outputRate</span><span class=p>:</span> <span class=nb>Double</span><span class=p>)</span> <span class=p>-&gt;</span> <span class=p>[</span><span class=nb>Float</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>guard</span> <span class=n>inputRate</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>outputRate</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span> <span class=n>inputRate</span> <span class=o>!=</span> <span class=n>outputRate</span><span class=p>,</span> <span class=o>!</span><span class=n>samples</span><span class=p>.</span><span class=bp>isEmpty</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>samples</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>guard</span> <span class=kd>let</span> <span class=nv>inputFormat</span> <span class=p>=</span> <span class=n>AVAudioFormat</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>commonFormat</span><span class=p>:</span> <span class=p>.</span><span class=n>pcmFormatFloat32</span><span class=p>,</span> <span class=n>sampleRate</span><span class=p>:</span> <span class=n>inputRate</span><span class=p>,</span> <span class=n>channels</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=n>interleaved</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>outputFormat</span> <span class=p>=</span> <span class=n>AVAudioFormat</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>commonFormat</span><span class=p>:</span> <span class=p>.</span><span class=n>pcmFormatFloat32</span><span class=p>,</span> <span class=n>sampleRate</span><span class=p>:</span> <span class=n>outputRate</span><span class=p>,</span> <span class=n>channels</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=n>interleaved</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>converter</span> <span class=p>=</span> <span class=n>AVAudioConverter</span><span class=p>(</span><span class=n>from</span><span class=p>:</span> <span class=n>inputFormat</span><span class=p>,</span> <span class=n>to</span><span class=p>:</span> <span class=n>outputFormat</span><span class=p>)</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>samples</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>guard</span> <span class=kd>let</span> <span class=nv>inputBuffer</span> <span class=p>=</span> <span class=n>AVAudioPCMBuffer</span><span class=p>(</span><span class=n>pcmFormat</span><span class=p>:</span> <span class=n>inputFormat</span><span class=p>,</span> <span class=n>frameCapacity</span><span class=p>:</span> <span class=n>AVAudioFrameCount</span><span class=p>(</span><span class=n>samples</span><span class=p>.</span><span class=bp>count</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>          <span class=kd>let</span> <span class=nv>outputBuffer</span> <span class=p>=</span> <span class=n>AVAudioPCMBuffer</span><span class=p>(</span><span class=n>pcmFormat</span><span class=p>:</span> <span class=n>outputFormat</span><span class=p>)</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>samples</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>inputBuffer</span><span class=p>.</span><span class=n>frameLength</span> <span class=p>=</span> <span class=n>AVAudioFrameCount</span><span class=p>(</span><span class=n>samples</span><span class=p>.</span><span class=bp>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>inputData</span> <span class=p>=</span> <span class=n>inputBuffer</span><span class=p>.</span><span class=n>floatChannelData</span><span class=p>!</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=k>in</span> <span class=mf>0.</span><span class=p>.&lt;</span><span class=n>samples</span><span class=p>.</span><span class=bp>count</span> <span class=p>{</span> <span class=n>inputData</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>samples</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>ratio</span> <span class=p>=</span> <span class=n>outputRate</span> <span class=o>/</span> <span class=n>inputRate</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>outputFrameCount</span> <span class=p>=</span> <span class=nb>Int</span><span class=p>(</span><span class=n>ceil</span><span class=p>(</span><span class=nb>Double</span><span class=p>(</span><span class=n>samples</span><span class=p>.</span><span class=bp>count</span><span class=p>)</span> <span class=o>*</span> <span class=n>ratio</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>outputBuffer</span><span class=p>.</span><span class=n>frameCapacity</span> <span class=p>=</span> <span class=n>AVAudioFrameCount</span><span class=p>(</span><span class=n>outputFrameCount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nv>error</span><span class=p>:</span> <span class=n>NSError</span><span class=p>?</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>status</span> <span class=p>=</span> <span class=n>converter</span><span class=p>.</span><span class=n>convert</span><span class=p>(</span><span class=n>to</span><span class=p>:</span> <span class=n>outputBuffer</span><span class=p>,</span> <span class=n>error</span><span class=p>:</span> <span class=p>&amp;</span><span class=n>error</span><span class=p>)</span> <span class=p>{</span> <span class=kc>_</span><span class=p>,</span> <span class=n>outStatus</span> <span class=k>in</span>
</span></span><span class=line><span class=cl>        <span class=n>outStatus</span><span class=p>.</span><span class=n>pointee</span> <span class=p>=</span> <span class=p>.</span><span class=n>haveData</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>inputBuffer</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>guard</span> <span class=n>status</span> <span class=p>==</span> <span class=p>.</span><span class=n>haveData</span><span class=p>,</span> <span class=n>error</span> <span class=p>==</span> <span class=kc>nil</span> <span class=k>else</span> <span class=p>{</span> <span class=k>return</span> <span class=n>samples</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>outputData</span> <span class=p>=</span> <span class=n>outputBuffer</span><span class=p>.</span><span class=n>floatChannelData</span><span class=p>!</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nv>outputLength</span> <span class=p>=</span> <span class=nb>Int</span><span class=p>(</span><span class=n>outputBuffer</span><span class=p>.</span><span class=n>frameLength</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=mf>0.</span><span class=p>.&lt;</span><span class=n>outputLength</span><span class=p>).</span><span class=bp>map</span> <span class=p>{</span> <span class=n>outputData</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=nv>$0</span><span class=p>]</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p><strong>实现要点：</strong></p><ol><li><strong>内存安全</strong>：使用 <code>UnsafeMutableAudioBufferListPointer</code> 和 <code>defer</code> 确保内存正确释放</li><li><strong>多格式支持</strong>：支持 Float32、Int16、Int32 格式</li><li><strong>字节序处理</strong>：支持大端和小端字节序</li><li><strong>非交错格式</strong>：正确处理每个通道独立 buffer 的格式</li><li><strong>混音</strong>：立体声自动混音为单声道</li><li><strong>高质量重采样</strong>：使用系统 AVAudioConverter</li></ol><hr><h2 id=二extension与主应用数据共享>二、Extension与主应用数据共享<a hidden class=anchor aria-hidden=true href=#二extension与主应用数据共享>#</a></h2><p>Broadcast Extension与主应用运行在不同进程，涉及到进程间通信，这里选择使用实现比较简单的App Group共享容器进行数据交换。</p><h3 id=app-group配置>App Group配置<a hidden class=anchor aria-hidden=true href=#app-group配置>#</a></h3><p><strong>Entitlements配置：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;key&gt;</span>com.apple.security.application-groups<span class=nt>&lt;/key&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;array&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;string&gt;</span>group.com.xxx.shared<span class=nt>&lt;/string&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/array&gt;</span></span></span></code></pre></td></tr></table></div></div><p>需要在Apple Developer Portal创建App Group，并在XCode中为两个target启用。</p><h3 id=数据读写实现>数据读写实现<a hidden class=anchor aria-hidden=true href=#数据读写实现>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-swift data-lang=swift><span class=line><span class=cl><span class=kd>class</span> <span class=nc>AudioSharedBuffer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>let</span> <span class=nv>appGroupId</span> <span class=p>=</span> <span class=s>&#34;group.com.xxx.shared&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>let</span> <span class=nv>sharedContainerURL</span> <span class=p>=</span> <span class=n>FileManager</span><span class=p>.</span><span class=k>default</span><span class=p>.</span><span class=n>containerURL</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>forSecurityApplicationGroupIdentifier</span><span class=p>:</span> <span class=kc>Self</span><span class=p>.</span><span class=n>appGroupId</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Extension写入处理后的音频</span>
</span></span><span class=line><span class=cl>    <span class=kd>func</span> <span class=nf>writeAudioSamples</span><span class=p>(</span><span class=kc>_</span> <span class=n>samples</span><span class=p>:</span> <span class=p>[</span><span class=nb>Float</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>guard</span> <span class=kd>let</span> <span class=nv>url</span> <span class=p>=</span> <span class=n>sharedContainerURL</span><span class=p>?.</span><span class=n>appendingPathComponent</span><span class=p>(</span><span class=s>&#34;audio.raw&#34;</span><span class=p>)</span> <span class=k>else</span> <span class=p>{</span> <span class=k>return</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nv>data</span> <span class=p>=</span> <span class=n>samples</span><span class=p>.</span><span class=n>withUnsafeBufferPointer</span> <span class=p>{</span> <span class=n>Data</span><span class=p>(</span><span class=n>buffer</span><span class=p>:</span> <span class=nv>$0</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>FileManager</span><span class=p>.</span><span class=k>default</span><span class=p>.</span><span class=n>fileExists</span><span class=p>(</span><span class=n>atPath</span><span class=p>:</span> <span class=n>url</span><span class=p>.</span><span class=n>path</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>let</span> <span class=nv>handle</span> <span class=p>=</span> <span class=k>try</span><span class=p>?</span> <span class=n>FileHandle</span><span class=p>(</span><span class=n>forWritingTo</span><span class=p>:</span> <span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>handle</span><span class=p>?.</span><span class=n>seekToEndOfFile</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>handle</span><span class=p>?.</span><span class=n>write</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>handle</span><span class=p>?.</span><span class=n>closeFile</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>?</span> <span class=n>data</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=n>to</span><span class=p>:</span> <span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>postDarwinNotification</span><span class=p>(</span><span class=s>&#34;com.xxx.newAudioData&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 主应用读取音频</span>
</span></span><span class=line><span class=cl>    <span class=kd>func</span> <span class=nf>readAudioSamples</span><span class=p>()</span> <span class=p>-&gt;</span> <span class=p>[</span><span class=nb>Float</span><span class=p>]?</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>guard</span> <span class=kd>let</span> <span class=nv>url</span> <span class=p>=</span> <span class=n>sharedContainerURL</span><span class=p>?.</span><span class=n>appendingPathComponent</span><span class=p>(</span><span class=s>&#34;audio.raw&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>              <span class=n>FileManager</span><span class=p>.</span><span class=k>default</span><span class=p>.</span><span class=n>fileExists</span><span class=p>(</span><span class=n>atPath</span><span class=p>:</span> <span class=n>url</span><span class=p>.</span><span class=n>path</span><span class=p>)</span> <span class=k>else</span> <span class=p>{</span> <span class=k>return</span> <span class=kc>nil</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nv>data</span> <span class=p>=</span> <span class=k>try</span><span class=p>?</span> <span class=n>Data</span><span class=p>(</span><span class=n>contentsOf</span><span class=p>:</span> <span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>?</span> <span class=n>FileManager</span><span class=p>.</span><span class=k>default</span><span class=p>.</span><span class=n>removeItem</span><span class=p>(</span><span class=n>at</span><span class=p>:</span> <span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nv>floatCount</span> <span class=p>=</span> <span class=n>data</span><span class=p>?.</span><span class=bp>count</span> <span class=p>??</span> <span class=mi>0</span> <span class=o>/</span> <span class=n>MemoryLayout</span><span class=p>&lt;</span><span class=nb>Float</span><span class=p>&gt;.</span><span class=n>size</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nv>samples</span> <span class=p>=</span> <span class=p>[</span><span class=nb>Float</span><span class=p>](</span><span class=n>repeating</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=bp>count</span><span class=p>:</span> <span class=n>floatCount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>?.</span><span class=n>copyBytes</span><span class=p>(</span><span class=n>to</span><span class=p>:</span> <span class=n>samples</span><span class=p>.</span><span class=n>withUnsafeMutableBufferPointer</span> <span class=p>{</span> <span class=nv>$0</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>samples</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>func</span> <span class=nf>postDarwinNotification</span><span class=p>(</span><span class=kc>_</span> <span class=n>name</span><span class=p>:</span> <span class=nb>String</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nv>center</span> <span class=p>=</span> <span class=n>CFNotificationCenterGetDarwinNotifyCenter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>CFNotificationCenterPostNotification</span><span class=p>(</span><span class=n>center</span><span class=p>,</span> <span class=n>CFNotificationName</span><span class=p>(</span><span class=n>name</span> <span class=k>as</span> <span class=n>CFString</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=darwin通知>Darwin通知<a hidden class=anchor aria-hidden=true href=#darwin通知>#</a></h3><p>Extension写入数据后发送Darwin通知，主应用监听后立即读取：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-swift data-lang=swift><span class=line><span class=cl><span class=kd>func</span> <span class=nf>startListening</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>CFNotificationCenterAddObserver</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>CFNotificationCenterGetDarwinNotifyCenter</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nb>Unmanaged</span><span class=p>.</span><span class=n>passUnretained</span><span class=p>(</span><span class=kc>self</span><span class=p>).</span><span class=n>toOpaque</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span> <span class=kc>_</span><span class=p>,</span> <span class=n>observer</span><span class=p>,</span> <span class=kc>_</span><span class=p>,</span> <span class=kc>_</span><span class=p>,</span> <span class=kc>_</span> <span class=k>in</span>
</span></span><span class=line><span class=cl>            <span class=k>guard</span> <span class=kd>let</span> <span class=nv>observer</span> <span class=p>=</span> <span class=n>observer</span> <span class=k>else</span> <span class=p>{</span> <span class=k>return</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=kd>let</span> <span class=nv>selfPtr</span> <span class=p>=</span> <span class=nb>Unmanaged</span><span class=p>&lt;</span><span class=n>YourClass</span><span class=p>&gt;.</span><span class=n>fromOpaque</span><span class=p>(</span><span class=n>observer</span><span class=p>).</span><span class=n>takeUnretainedValue</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=kd>let</span> <span class=nv>samples</span> <span class=p>=</span> <span class=n>selfPtr</span><span class=p>.</span><span class=n>audioBuffer</span><span class=p>.</span><span class=n>readAudioSamples</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>selfPtr</span><span class=p>.</span><span class=n>onAudioReceived</span><span class=p>?(</span><span class=n>samples</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;com.xxx.newAudioData&#34;</span> <span class=k>as</span> <span class=n>CFString</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>deliverImmediately</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><hr><h2 id=samplehandler完整示例>SampleHandler完整示例<a hidden class=anchor aria-hidden=true href=#samplehandler完整示例>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-swift data-lang=swift><span class=line><span class=cl><span class=kd>class</span> <span class=nc>SampleHandler</span><span class=p>:</span> <span class=n>RPBroadcastSampleHandler</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>let</span> <span class=nv>sharedBuffer</span> <span class=p>=</span> <span class=n>AudioSharedBuffer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>let</span> <span class=nv>targetSampleRate</span><span class=p>:</span> <span class=nb>Double</span> <span class=p>=</span> <span class=mf>16000.0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>override</span> <span class=kd>func</span> <span class=nf>broadcastStarted</span><span class=p>(</span><span class=n>withSetupInfo</span> <span class=n>setupInfo</span><span class=p>:</span> <span class=p>[</span><span class=nb>String</span> <span class=p>:</span> <span class=n>NSObject</span><span class=p>]?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sharedBuffer</span><span class=p>.</span><span class=n>clearAudioData</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>override</span> <span class=kd>func</span> <span class=nf>broadcastPaused</span><span class=p>()</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>override</span> <span class=kd>func</span> <span class=nf>broadcastResumed</span><span class=p>()</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>override</span> <span class=kd>func</span> <span class=nf>broadcastFinished</span><span class=p>()</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>override</span> <span class=kd>func</span> <span class=nf>processSampleBuffer</span><span class=p>(</span><span class=kc>_</span> <span class=n>sampleBuffer</span><span class=p>:</span> <span class=n>CMSampleBuffer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>with</span> <span class=n>sampleBufferType</span><span class=p>:</span> <span class=n>RPSampleBufferType</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>switch</span> <span class=n>sampleBufferType</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=p>.</span><span class=n>audioApp</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 处理应用音频（系统播放的音频）</span>
</span></span><span class=line><span class=cl>            <span class=kd>let</span> <span class=nv>samples</span> <span class=p>=</span> <span class=n>convertTo16kMono</span><span class=p>(</span><span class=n>sampleBuffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>sharedBuffer</span><span class=p>.</span><span class=n>writeAudioSamples</span><span class=p>(</span><span class=n>samples</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=p>.</span><span class=n>audioMic</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 忽略麦克风音频</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=p>.</span><span class=n>video</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 忽略视频</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://lyapple2008.github.io/tags/ios%E5%BC%80%E5%8F%91/>IOS开发</a></li><li><a href=https://lyapple2008.github.io/tags/%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/>开发日志</a></li><li><a href=https://lyapple2008.github.io/tags/%E5%8F%8C%E8%AF%AD%E5%AD%97%E5%B9%95/>双语字幕</a></li></ul><nav class=paginav><a class=prev href=https://lyapple2008.github.io/posts/202601/2026-02-01-%E5%85%B3%E4%BA%8Eaicoding%E7%9A%84%E4%B8%80%E4%BA%9B%E6%84%9F%E6%83%B3%E5%92%8C%E5%90%8E%E7%BB%AD%E7%9A%84%E8%A7%84%E5%88%92/><span class=title>« 上一页</span><br><span>关于AICoding的一些感想和后续的规划</span>
</a><a class=next href=https://lyapple2008.github.io/posts/202511/2025-11-03-%E4%BD%BF%E7%94%A8ort%E8%BF%9B%E8%A1%8C%E8%AF%AD%E9%9F%B3%E9%99%8D%E5%99%AA%E6%8E%A8%E7%90%86/><span class=title>下一页 »</span><br><span>使用ORT进行语音降噪模型推理</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share iOS音频捕获 on x" href="https://x.com/intent/tweet/?text=iOS%e9%9f%b3%e9%a2%91%e6%8d%95%e8%8e%b7&amp;url=https%3a%2f%2flyapple2008.github.io%2fposts%2f202601%2f2026-01-25-ios%25E9%259F%25B3%25E9%25A2%2591%25E6%258D%2595%25E8%258E%25B7%2f&amp;hashtags=iOS%e5%bc%80%e5%8f%91%2c%e5%bc%80%e5%8f%91%e6%97%a5%e5%bf%97%2c%e5%8f%8c%e8%af%ad%e5%ad%97%e5%b9%95"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share iOS音频捕获 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2flyapple2008.github.io%2fposts%2f202601%2f2026-01-25-ios%25E9%259F%25B3%25E9%25A2%2591%25E6%258D%2595%25E8%258E%25B7%2f&amp;title=iOS%e9%9f%b3%e9%a2%91%e6%8d%95%e8%8e%b7&amp;summary=iOS%e9%9f%b3%e9%a2%91%e6%8d%95%e8%8e%b7&amp;source=https%3a%2f%2flyapple2008.github.io%2fposts%2f202601%2f2026-01-25-ios%25E9%259F%25B3%25E9%25A2%2591%25E6%258D%2595%25E8%258E%25B7%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share iOS音频捕获 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2flyapple2008.github.io%2fposts%2f202601%2f2026-01-25-ios%25E9%259F%25B3%25E9%25A2%2591%25E6%258D%2595%25E8%258E%25B7%2f&title=iOS%e9%9f%b3%e9%a2%91%e6%8d%95%e8%8e%b7"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share iOS音频捕获 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2flyapple2008.github.io%2fposts%2f202601%2f2026-01-25-ios%25E9%259F%25B3%25E9%25A2%2591%25E6%258D%2595%25E8%258E%25B7%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share iOS音频捕获 on whatsapp" href="https://api.whatsapp.com/send?text=iOS%e9%9f%b3%e9%a2%91%e6%8d%95%e8%8e%b7%20-%20https%3a%2f%2flyapple2008.github.io%2fposts%2f202601%2f2026-01-25-ios%25E9%259F%25B3%25E9%25A2%2591%25E6%258D%2595%25E8%258E%25B7%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share iOS音频捕获 on telegram" href="https://telegram.me/share/url?text=iOS%e9%9f%b3%e9%a2%91%e6%8d%95%e8%8e%b7&amp;url=https%3a%2f%2flyapple2008.github.io%2fposts%2f202601%2f2026-01-25-ios%25E9%259F%25B3%25E9%25A2%2591%25E6%258D%2595%25E8%258E%25B7%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share iOS音频捕获 on ycombinator" href="https://news.ycombinator.com/submitlink?t=iOS%e9%9f%b3%e9%a2%91%e6%8d%95%e8%8e%b7&u=https%3a%2f%2flyapple2008.github.io%2fposts%2f202601%2f2026-01-25-ios%25E9%259F%25B3%25E9%25A2%2591%25E6%258D%2595%25E8%258E%25B7%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><section><h2>Comments</h2><div id=comments-utteranc></div></section><script type=text/javascript>function getCurrentTheme(){return document.documentElement.getAttribute("data-theme")||document.body.classList.contains("dark")?"dark":"light"}function loadUtterances(e=!1){const t=document.getElementById("comments-utteranc");if(t!==null){t.innerHTML="";const n=document.createElement("script");n.setAttribute("id","utteranc"),n.setAttribute("src","https://utteranc.es/client.js"),n.setAttribute("data-repo","lyapple2008/comment"),n.setAttribute("data-category","Announcements"),n.setAttribute("data-mapping","pathname"),n.setAttribute("data-reactions-enabled","1"),n.setAttribute("data-emit-metadata","0"),n.setAttribute("data-theme",e?"github-dark":"github-light"),n.setAttribute("data-issue-term","title"),n.setAttribute("crossorigin","anonymous"),n.setAttribute("async","true"),t.appendChild(n)}}const isDarkMode=getCurrentTheme()==="dark";loadUtterances(isDarkMode);const themeObserver=new MutationObserver(e=>{e.forEach(e=>{if(e.type==="attributes"&&e.attributeName==="class"){const e=getCurrentTheme()==="dark";loadUtterances(e),console.log(`changing theme`)}})});themeObserver.observe(document.body,{attributes:!0,attributeFilter:["class"]})</script></article></main><footer class=footer><span>See this site&rsquo;s source code <a href=https://github.com/lyapple2008/lyapple2008.github.io>here</a>, licensed under GPLv3 ·</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>